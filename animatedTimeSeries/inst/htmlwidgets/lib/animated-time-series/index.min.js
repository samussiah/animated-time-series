!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=n()}(this,(function(){"use strict";var t={addElement:function(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,n){return n};return i?n.selectAll("".concat(e,".atm-").concat(t,".atm-").concat(e)).data(i,a).join(e).classed("atm-".concat(t," atm-").concat(e),!0):n.append(e).classed("atm-".concat(t," atm-").concat(e),!0)}};function n(t){return null===t.stratification_var&&(t.stratificaton_var=t.id_var),null===t.color_var&&(t.color_var=t.stratification_var),null===t.varLabels.stratification&&(t.varLabels.stratification=t.stratification_var),["ordinal","discrete"].includes(t.xType)||(t.xType="ordinal"),"ordinal"===t.xType?t.xVar="visit":"discrete"===t.xType&&(t.xVar="timepoint"),null===t.yLabel&&(t.yLabel="".concat(t.varLabels[t.yVar]," - ").concat(t.aggregateLabels[t.aggregate])),["mean","geomean"].includes(t.aggregate)||(t.displayCIs=!1),t.alpha<=0|t.alpha>=1&&(t.alpha=.05),!0===t.displayCIs&&(t.yLabel="".concat(t.yLabel," (").concat(100*(1-t.alpha),"% CI)")),t.stratification_var!==t.color_var&&(t.annotate=!1,t.displayLegend=!0),t.footnotes=t.footnotes.map((function(n){return n.replace("[aggregate]",t.aggregate).replace("[outcome]",t.outcome)})),t}function e(){return{update:n,stratification_var:null,color_var:null,id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",varLabels:{stratification:null,color_var:null,id:"Participant ID",visit:"Visit",visit_order:"Visit Order",day:"Study Day",measure:"Measure",result:"Result"},xType:"ordinal",xVar:"visit",xLabel:"Visit",rotateXTickLabels:!0,yType:"continuous",yVar:"result",yLabel:null,aggregate:"mean",aggregateLabels:{mean:"Mean",median:"Median",geomean:"Geometric Mean",deviation:"Standard Deviation"},displayCIs:!0,alpha:.05,colorScheme:d3.schemeSet2,displayLegend:!1,annotate:!0,offset:7.5,pointRadius:5,strokeWidth:3,fontSize:15,fontWeight:"bold",play:!0,timepoint:0,measureIndex:0,measureOrder:[],speed:1e3,pause:5e3,width:null,widthFactor:2,height:null,heightFactor:2,margin:{top:50,right:100,bottom:100,left:75},footnotes:[]}}function i(t){return this.util.addElement("charts",t)}function a(){var t=this.util.addElement("main",d3.select(this.element)),n=this.util.addElement("legend",t),e=i.call(this,t),a=function(t,n){var e=t.node().clientWidth/n.widthFactor;return{width:e,height:e/n.heightFactor}}(e,this.settings),r=a.width,s=a.height;return this.settings.width=r,this.settings.height=s,this.settings.dimensions={width:r,height:s,margin:this.settings.margin,widthAdj:r-this.settings.margin.left-this.settings.margin.right,heightAdj:s-this.settings.margin.top-this.settings.margin.bottom},{main:t,legend:n,charts:e}}function r(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function s(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,i)}return e}function o(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,n){if(!t)return;if("string"==typeof t)return l(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(t);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return l(t,n)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,i=new Array(n);e<n;e++)i[e]=t[e];return i}function c(t,n){var e=t.length,i=t.map((function(t){var e=function(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?s(Object(e),!0).forEach((function(n){r(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):s(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}({},t);return Object.keys(n).filter((function(t){return/_var$/.test(t)})).forEach((function(i){e[i.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(i)?parseFloat(t[n[i]]):e[n[i]]})),e})).filter((function(t){return!isNaN(t.result)})),a=e-i.length;return a>0&&console.warn("".concat(a," rows without results removed.")),i}function u(t,n){var e;switch(t){case"visit":e=o(new Set(n.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,n){return t.replace(/.*\|/,"")-n.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:e=o(new Set(n.map((function(n){return n[t]}))).values()).sort()}return e}function d(t,n){var e={};return e.stratification=u("stratification",t),e.color=u("color",t),e.id=u("id",t),e.visit=u("visit",t),e.visit_order=u("visit_order",t),e.day=u("day",t),e.measure=u("measure",t),e.strata=e.stratification.reduce((function(n,e){var i=t.filter((function(t){return t.stratification===e})).map((function(t){return t.id})),a=new Set(i).size;return n[e]=a,n}),{}),e.timepoint=e.visit.map((function(n){return d3.median(t.filter((function(t){return t.visit===n})),(function(t){return t.day}))})),e.offsets=d3.range(Math.ceil(-e.stratification.length/2)*n.offset+n.offset/2*!(e.stratification.length%2),Math.ceil(e.stratification.length/2)*n.offset+n.offset/2*!(e.stratification.length%2),n.offset),e}function f(t,n,e){var i=function(t,n,e){var i=t[0].measure,a=t[0].stratification,r=e.get(i),s=t.map((function(t){return t.result})).sort((function(t,n){return t-n}));if(["geomean"].includes(n.aggregate)){var o=0;s=s.map((function(t){return t<=0&&(t=r,o++),t})),o>0&&console.warn("".concat(o," non-positive ").concat(i," results for ").concat(a," set to ").concat(r,", the smallest positive result."))}var l=s.filter((function(t){return t!==1/0}));return l.length<s.length&&console.warn("".concat(s.length-l.length," infinite ").concat(i," results for ").concat(a," removed.")),l}(t,n,e),a=(jStat(i),t.length),r=d3.mean(i),s=d3.deviation(i),o=jStat.tci(r,n.alpha,i),l=d3.min(i),c=d3.median(i),u=d3.max(i),d=jStat.geomean(i),f={n:a,mean:r,deviation:s,mean_ci:o,min:l,median:c,max:u,geomean:d,geomean_ci:jStat.tci(Math.log(d),n.alpha,i.map((function(t){return Math.log(t)}))).map((function(t){return Math.exp(t)}))};return{data:t,stats:f,value:f[n.aggregate]}}function g(t,n,e){var i=d3.rollup(t,(function(t){return d3.min(t.map((function(t){return t.result})).filter((function(t){return t>0})))}),(function(t){return t.measure}));return function(t,n,e){var i=structuredClone(t);return i.forEach((function(t,i){var a=Array(n.stratification.length*n.visit.length);n.stratification.forEach((function(i,r){var s=t[1].find((function(t){return t[0]===i}));void 0===s&&(s=[i,n.visit.map((function(t){return[t,{data:[],value:null}]}))],t[1].splice(r,0,s)),s&&s[1].sort((function(t,e){return n.visit.indexOf(t[0])-n.visit.indexOf(e[0])})),s.color_value=s[1][0][1].data[0][e.color_var],s.offset=n.offsets[r],n.visit.forEach((function(e,i){var l=s[1].find((function(t){return t[0]===e}));void 0===l&&(l=o(s[1][i-1]),s[1].splice(i,0,l)),l.visit=l[0],l.index=n.visit.findIndex((function(t){return t===l[0]})),l.visit_order=n.visit_order[l.index],l.timepoint=n.timepoint[l.index],l.stratum=s;var c={measure:t[0],stratum:s[0],visit:l[0],value:l[0]===e?l[1].value:null};a[r*n.visit.length+i]=c}))})),t.tabular=a.filter((function(t){return!0})),t.visits=o(new Set(t.tabular.map((function(t){return t.visit}))).values())})),i}(d3.rollups(t,(function(t){return f(t,e,i)}),(function(t){return t.measure}),(function(t){return t.stratification}),(function(t){return t.visit})),n,e)}function h(){this.data.cleansed=c.call(this,this.data.raw,this.settings),this.data.set=d.call(this,this.data.cleansed,this.settings),this.data.nested=g.call(this,this.data.cleansed,this.data.set,this.settings)}function m(t,n){return{index:t,visit:n.visit[t],visit_order:n.visit_order[t],timepoint:n.timepoint[t]}}function p(t,n,e){var i=t.tabular.map((function(t){return t.value}));return e.displayCIs&&t[1].map((function(t){return t[1]})).flat().map((function(t){return t[1].stats["".concat(e.aggregate,"_ci")]})).flat().forEach((function(t){return i.push(t)})),d3.scaleLinear().domain([d3.min(i),d3.max(i)]).nice().range(n)}function v(t,n,e){var i={index:e.measureIndex,data:t[e.measureIndex],scales:n};return i.scales.y=p(i.data,[e.dimensions.heightAdj,0],e),i}var y={x:function(t,n,e){var i;if("ordinal"===e)i=d3.scalePoint().domain(t).range(n).padding([.5]);else{var a=d3.extent(t),r=a[1]-a[0];i=d3.scaleLinear().domain([a[0]-.05*r,a[1]+.05*r]).range(n)}return i},y:p,color:function(t,n){return d3.scaleOrdinal().domain(t).range(n)}};function x(t,n){var e=this,i=t.selectAll("div.atm-legend-item").data(n.domain()).join("div").classed("atm-legend-item",!0).append("p").classed("atm-legend-item__content",!0);i.append("span").classed("atm-legend-item__symbol",!0).style("background",(function(t,e){return n(t)})),i.insert("text").classed("atm-legend-item__text",!0).text((function(t,n){return"".concat(t," (n=").concat(e.data.set.strata[t],")")}))}function b(t,n){var e=this.layout.charts.append("div").classed("atm-container atm-div",!0),i=this.util.addElement("header",e,"h3").text(t).style("display","none"),a=this.util.addElement("time-series__svg",e,"svg").attr("width",n.width).attr("height",n.height).style("display","none"),r=this.util.addElement("time-series__g",a,"g").attr("transform","translate("+n.margin.left+","+n.margin.top+")").style("display","none"),s=e.style("width","0%").transition().duration(this.settings.speed).style("width","50%");return{canvas:r,mainTransition:s,transitionEnd:function(){i.style("display",null),a.style("display",null),r.style("display",null)}}}function _(t,n,e,i,a){var r=this,s=t.append("g").classed("atm-axis",!0).attr("transform","translate(0,"+e.heightAdj+")");return"ordinal"===i?s.call(d3.axisBottom(n)):s.call(d3.axisBottom(n).tickValues(a.timepoint).tickFormat((function(t,n){return a.visit[n]}))),this.settings.rotateXTickLabels&&s.selectAll("text").style("text-anchor","end").attr("transform","rotate(-45)").attr("dx","-.8em").attr("dy",".15em"),s.label=t.append("g").call((function(t){t.append("text").attr("class","axis-label").attr("text-anchor","middle").attr("font-size",16).attr("font-weight","bold").attr("x",e.widthAdj/2).attr("y",e.heightAdj+e.margin.bottom-32).text(r.settings.xLabel)})),s}function j(t,n,e){var i=this,a=t.append("g").classed("atm-axis",!0).call(d3.axisLeft(n));return a.gridLines=t.append("g").call((function(t){t.attr("class","grid-lines").selectAll("line").data(n.ticks()).join("line").attr("x1",0).attr("x2",e.widthAdj).attr("y1",(function(t){return n(t)})).attr("y2",(function(t){return n(t)}))})),a.label=t.append("g").call((function(t){t.append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("text-anchor","middle").attr("font-size",16).attr("font-weight","bold").attr("x",-e.heightAdj/2).attr("y",-(e.margin.left-32)).text(i.settings.yLabel)})),a}function w(t){var n=this.settings.dimensions,e=b.call(this,t.data[0],n),i=e.canvas;return{canvas:i,mainTransition:e.mainTransition,transitionEnd:e.transitionEnd,xAxis:_.call(this,i,t.scales.x,n,this.settings.xType,this.data.set,t.visits),yAxis:j.call(this,i,t.scales.y,n)}}function A(t,n,e){var i=this,a=d3.line().x((function(t){return e.x(t[i.settings.xVar])+t.stratum.offset})).y((function(t){return e.y(t[1].value)})),r=t.selectAll("path.line").data(n).join("path").classed("line",!0);return r.attr("d",(function(t){var n=t[1][i.settings.timepoint],e=t[1].map((function(t,e){return e>=i.settings.timepoint?n:t}));return a(e)})).attr("stroke",(function(t){return e.color(t.color_value)})).attr("stroke-width",this.settings.strokeWidth).attr("stroke-opacity",.75).attr("fill","none"),r.lineGenerator=a,r}function O(t,n,e){var i=this,a=t.selectAll("g.point-group").data(n,(function(t){return t[0]})).join("g").classed("point-group",!0);return a.attr("fill",(function(t){return e.color(t.color_value)})),a.selectAll("circle.point").data((function(t){return t[1].slice(0,i.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join("circle").classed("point",!0).attr("cx",(function(t){return e.x(t[i.settings.xVar])+t.stratum.offset})).attr("cy",(function(t){return e.y(t[1].value)})).attr("stroke","white").attr("r",0).transition().duration(this.settings.speed/2).attr("r",this.settings.pointRadius),a}function S(t,n,e){var i=this,a=t.selectAll("g.ci-group").data(n,(function(t){return t[0]})).join("g").classed("ci-group",!0);return a.attr("stroke",(function(t){return e.color(t.color_value)})).attr("stroke-width",this.settings.strokeWidth),a.selectAll("line.ci").data((function(t){return t[1].slice(0,i.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join("line").classed("ci",!0).attr("x1",(function(t){return e.x(t[i.settings.xVar])+t.stratum.offset})).attr("x2",(function(t){return e.x(t[i.settings.xVar])+t.stratum.offset})).attr("y1",(function(t){return e.y(t[1].value)})).attr("y2",(function(t){return e.y(t[1].value)})).attr("stroke-linecap","round").transition().duration(this.settings.speed/4).delay(this.settings.speed/2).attr("y1",(function(t){return e.y(t[1].stats["".concat(i.settings.aggregate,"_ci")][0])})).attr("y2",(function(t){return e.y(t[1].stats["".concat(i.settings.aggregate,"_ci")][1])})),a}function I(t){var n=this.settings.fontSize;t.sort((function(t,n){return n.y-t.y})).forEach((function(e,i){if(i>0){var a=t[i-1].y-e.y;a<n&&(e.y=e.y-(n-a))}}))}function L(t,n,e){var i=this,a=t.selectAll("text.annotation").data(n).join("text").classed("annotation",!0);return a.datum((function(t){var n=t[1][i.settings.timepoint];return{x:e.x(n[i.settings.xVar]),y:e.y(n[1].value),color:e.color(t[0]),text:t[0],stratum:t}})),I.call(this,a.data()),a.attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y})).attr("dx",this.settings.offset*this.data.set.stratification.length/2+3).attr("dy",this.settings.fontSize/3).attr("fill",(function(t){return t.color})).style("font-weight",this.settings.fontWeight).text((function(t){return t.text})).attr("font-size",0),a.transition().duration(this.settings.speed/this.data.set.stratification.length).delay((function(t,n){return n*i.settings.speed/i.data.set.stratification.length})).attr("font-size",this.settings.fontSize),a}function V(t){var n=t.data[1];t.lines=A.call(this,t.layout.canvas,n,t.scales),t.points=O.call(this,t.layout.canvas,n,t.scales),this.settings.displayCIs&&(t.CIs=S.call(this,t.layout.canvas,n,t.scales)),this.settings.annotate&&(t.annotations=L.call(this,t.layout.canvas,n,t.scales))}function k(t,n){var e=this;t.transition().duration(this.settings.speed-.25*this.settings.speed*this.settings.displayCIs).attr("d",(function(n){var i=n[1][e.settings.timepoint],a=n[1].map((function(t,n){return n>=e.settings.timepoint?i:t}));return t.lineGenerator(a)}))}function E(t,n){var e=this;return t.selectAll("circle.point").data((function(t){return t[1].slice(0,e.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join((function(t){return t.append("circle").classed("point",!0).attr("r",e.settings.pointRadius).attr("stroke","white").attr("cx",(function(t){var i=t.stratum[1][e.settings.timepoint-1];return n.x(i[e.settings.xVar])+i.stratum.offset})).attr("cy",(function(t){var i=t.stratum[1][e.settings.timepoint-1];return n.y(i[1].value)})).call((function(t){return t.transition().duration(e.settings.speed-.25*e.settings.speed*e.settings.displayCIs).attr("cx",(function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).attr("cy",(function(t){return n.y(t[1].value)}))}))})),t}function T(t,n){var e=this;return t.selectAll("line.ci").data((function(t){return t[1].slice(0,e.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join((function(t){return t.append("line").classed("ci",!0).attr("x1",(function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).attr("x2",(function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).attr("y1",(function(t){return n.y(t[1].value)})).attr("y2",(function(t){return n.y(t[1].value)})).call((function(t){return t.transition().duration(.25*e.settings.speed).delay(.75*e.settings.speed).attr("y1",(function(t){return n.y(t[1].stats["".concat(e.settings.aggregate,"_ci")][0])})).attr("y2",(function(t){return n.y(t[1].stats["".concat(e.settings.aggregate,"_ci")][1])})).attr("stroke-linecap","round")}))})),t}function C(t,n){var e=this;t.datum((function(t){var i=t.stratum[1][e.settings.timepoint];return{x:n.x(i[e.settings.xVar]),y:n.y(i[1].value),color:n.color(t.stratum[0]),text:t.stratum[0],stratum:t.stratum}})),I.call(this,t.data()),t.transition().duration(this.settings.speed-.25*this.settings.speed*this.settings.displayCIs).attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y}))}function P(t){var n=this;this.settings.timepoint++,this.settings.timepoint>=this.data.set.visit.length?(this.interval.stop(),this.settings.measureIndex++,d3.timeout((function(){n.settings.timepoint=0,n.timepoint=m(n.settings.timepoint,n.data.set),n.settings.measureIndex<n.data.set.measure.length&&(n.measure=v(n.data.nested,n.scales,n.settings),n.measure.layout=w.call(n,n.measure),n.measure.layout.mainTransition.on("end",(function(){n.measure.layout.transitionEnd(),V.call(n,n.measure),d3.timeout((function(){n.interval=d3.interval((function(){P.call(n,n.measure)}),n.settings.speed)}),2*n.settings.speed)})))}),this.settings.pause)):(this.timepoint=m(this.settings.timepoint,this.data.set),k.call(this,t.lines,t.scales),E.call(this,t.points,t.scales),this.settings.displayCIs&&T.call(this,t.CIs,t.scales),this.settings.annotate&&C.call(this,t.annotations,t.scales))}function M(){var t=this;this.timepoint=m(this.settings.timepoint,this.data.set),this.scales={x:y.x(this.data.set[this.settings.xVar],[0,this.settings.dimensions.widthAdj],this.settings.xType),color:y.color(this.data.set.color,this.settings.colorScheme)},this.settings.displayLegend&&x.call(this,this.layout.legend,this.scales.color),this.measure=v(this.data.nested,this.scales,this.settings),this.measure.layout=w.call(this,this.measure),this.measure.layout.mainTransition.on("end",(function(){t.measure.layout.transitionEnd(),V.call(t,t.measure),d3.timeout((function(){t.interval=d3.interval((function(){P.call(t,t.measure)}),t.settings.speed)}),2*t.settings.speed)}))}return function(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={data:{raw:n},element:i,settings:e().update(Object.assign(e(),r)),util:t};return s.layout=a.call(s),h.call(s),M.call(s),s}}));
