!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=i()}(this,(function(){"use strict";function t(t,i,n){return t.find((function(t){return t[i]===n}))}var i={addElement:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,i){return i};return e?i.selectAll("".concat(n,".atm-").concat(t,".atm-").concat(n)).data(e,r).join(n).classed("atm-".concat(t," atm-").concat(n),!0):i.append(n).classed("atm-".concat(t," atm-").concat(n),!0)},getDatum:t,getValue:function(i,n,e,r){var s=t(i,n,e);return s?s[r]:null}};function n(){var t=this;null===this.settings.var_labels.stratification&&(this.settings.var_labels.stratification=this.settings.stratification_var),this.settings.footnotes=this.settings.footnotes.map((function(i){return i.replace("[color]",t.settings.color_var.replace("_"," "))})),null!==this.settings.y_limits&&this.settings.footnotes.push("<sup>*</sup> To mitigate the effect of outliers, the range of the y-axis encompasses the ".concat(this.settings.y_limits.map((function(t){return"".concat(t,"th")})).join(" through ")," quantile of the results."))}function e(){return{update:n,stratification_var:null,id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",change_var:"CHG",percent_change_var:"PCHG",outcome:"result",var_labels:{stratification:null,id:"Participant ID",visit:"Visit",visit_order:"Visit Order",measure:"Measure",result:"Result",baseline:"Baseline",change:"Change",chg:"Change",percent_change:"% Change",pchg:"% Change",fold_change:"Fold Change",fchg:"Fold Change"},aggregate:"mean",play:!0,timepoint:0,speed:1e3,loop_delay:1e4,x_var:"day",x_type:"linear",y_var:"result",y_type:"linear",y_limits:null,color_var:"change",color_type:"linear",width:null,height:null,margin:{},footnotes:["<sup>1</sup> The color of points represents [color] from baseline.","<sup>2</sup> The color of lines represents [color] from the previous timepoint."]}}function r(t,i,n){return i in t?Object.defineProperty(t,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[i]=n,t}function s(t,i){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(t);i&&(e=e.filter((function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable}))),n.push.apply(n,e)}return n}function a(t){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?s(Object(n),!0).forEach((function(i){r(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}function o(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,i){if(!t)return;if("string"==typeof t)return l(t,i);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(t,i)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,i){(null==i||i>t.length)&&(i=t.length);for(var n=0,e=new Array(i);n<i;n++)e[n]=t[n];return e}function c(t){var i=this.layout?this.layout.charts:t;this.settings.width=i.node().clientWidth/1,this.settings.height=this.settings.width/3,this.settings.margin={top:30,right:30,bottom:40,left:40}}function u(t){d3.select(this).transition().duration(t.settings.speed/8).delay([0,t.set.visit.length-1].includes(t.settings.timepoint)?t.settings.loop_delay-t.settings.speed/8*2:t.settings.speed-t.settings.speed/8*2).style("opacity",0)}function h(t,i){t.style("opacity",0).transition().duration(i.settings.speed/8).style("opacity",1).on("end",(function(){u.call(this,i)}))}function d(){var t={index:this.settings.timepoint,visit:this.set.visit[this.settings.timepoint],visit_order:this.set.visit_order[this.settings.timepoint],day:this.set.timepoint[this.settings.timepoint]};return t.previous=void 0!==this.timepoint?this.timepoint:t,t.direction=t.index>=t.previous.index?">":"<",this.layout.timepoint.text(t.visit).call(h,this),t}function f(t){var i=this;t.sort((function(t,i){return i.visit_order-t.visit_order}));var n=t.find((function(t){return t.visit_order<=i.timepoint.visit_order}));return this.set.visit_order.map((function(e,r){return e>=i.timepoint.visit_order?a({},n):t.find((function(t){return t.visit_order<=e}))}))}function p(t){var i=this;t.lines.transition().duration(2*this.settings.speed/5).attr("d",(function(n){return t.lineGenerator(f.call(i,n))}))}function m(t,i){var n=this;i.attr("cx",(function(i){return t.xScale(i[n.settings.x_var])+("ordinal"===n.settings.x_type?t.xScale.bandwidth()/2:0)})).attr("cy",(function(i){return t.yScale(i[n.settings.y_var])})).attr("r",(function(t){return t.visit_order<=n.timepoint.visit_order?2:0})).attr("fill",(function(i){return t.colorScale(i[n.settings.color_var])})).attr("fill-opacity",.25).attr("stroke",(function(i){return t.colorScale(i[n.settings.color_var])})).attr("stroke-opacity",.5)}function g(t){var i=this,n=this;if(t.groups.each((function(i,e,r){var s=d3.select(this),a=i[1].filter((function(t){return[n.timepoint.visit,n.timepoint.previous.visit].includes(t.visit)}));if(2===a.length){var o=a.find((function(t){return t.visit===n.timepoint.previous.visit})),l=s.selectAll(".atm-circle").filter((function(t){return t===o})),c=a.find((function(t){return t.visit===n.timepoint.visit})),u=s.selectAll(".atm-circle").filter((function(t){return t===c}));"<"===n.timepoint.direction&&l.attr("r",0);var h=s.append("circle").classed("atm-circle--transition",!0).datum(o);m.call(n,t,h);var d=h.datum(c).transition().duration(2*n.settings.speed/5);m.call(n,t,d),d.on("end",(function(){">"===n.timepoint.direction&&u.attr("r",2),h.remove()}))}})),0===this.timepoint.index){var e=this.settings.speed/this.set.visit.length;t.points.transition().duration(e).delay((function(t,n){return e*(i.set.visit.length-i.set.visit.indexOf(t.visit))})).attr("r",0)}}function v(t){var i=this;if(t.linesAggregate.filter((function(t,n){return n===i.timepoint.index-1})).transition().duration(2*this.settings.speed/5).delay(1*this.settings.speed/5).attr("x2",(function(n,e){return"ordinal"===i.settings.x_type?t.xScale(i.timepoint.visit)+t.xScale.bandwidth()/2:t.xScale(i.timepoint.day)})).attr("y2",(function(i){return t.yScale(i[1][1])})),0===this.timepoint.index){var n=this.settings.speed/this.set.visit.length;t.linesAggregate.transition().duration(n).delay((function(t,e){return i.settings.speed-n*e})).attr("x2",(function(){return this.getAttribute("x1")})).attr("y2",(function(){return this.getAttribute("y1")}))}}function y(t){var i=this;if(this.timepoint.index>0?t.pointsAggregate.transition().ease(d3.easeQuad).duration(2*this.settings.speed/5).delay(2*this.settings.speed/5).attr("cx","ordinal"===this.settings.x_type?t.xScale(this.timepoint.visit)+t.xScale.bandwidth()/2:t.xScale(this.timepoint.day)).attr("cy",(function(n){return t.yScale(n[i.timepoint.index][1])})).attr("fill",(function(n,e){return t.colorScale(n[i.timepoint.index]["change"===i.settings.color_var?2:3])})):t.pointsAggregate.attr("cx","ordinal"===this.settings.x_type?t.xScale(this.timepoint.visit)+t.xScale.bandwidth()/2:t.xScale(this.timepoint.day)).attr("cy",(function(i){return t.yScale(i[0][1])})).attr("fill",t.colorScale(0)),t.pointsAggregate.clone().classed("atm-clone",!0),0===this.timepoint.index){var n=this.settings.speed/this.set.visit.length;t.layout.canvas.selectAll(".atm-clone").transition().duration(n).delay((function(t,i){return n*i})).attr("fill-opacity",0).attr("stroke-opacity",0).remove()}}function _(){var t=this;this.timepoint=d.call(this),this.group.measure.forEach((function(i,n){p.call(t,i),g.call(t,i),v.call(t,i),y.call(t,i)}))}function b(){var t,i,n=this;(this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length&&(this.settings.timepoint=0),0===this.settings.timepoint)?(null===(t=this.interval)||void 0===t||t.stop(),null===(i=this.timeout)||void 0===i||i.stop(),this.timeout=d3.timeout((function(){_.call(n),n.timeout.stop(),n.timeout=d3.timeout((function(){n.interval=x.call(n)}),n.settings.loop_delay)}),this.settings.loop_delay)):_.call(this)}function x(){var t=this;return d3.interval((function(){b.call(t)}),this.settings.speed)}function S(t){var i=this,n=this.util.addElement("play",t),e=this.util.addElement("button",n,"input").attr("type","button").property("value",this.settings.play?"pause":"play");return e.on("click",(function(t,n){var e,r;i.settings.play=!i.settings.play,d3.select(this).property("value",i.settings.play?"pause":"play"),null===(e=i.timeout)||void 0===e||e.stop(),null===(r=i.interval)||void 0===r||r.stop(),i.layout.timepoint.transition().style("opacity",1),i.settings.play&&(i.interval=x.call(i))})),{container:n,input:e}}function A(t){var i=this,n=this.util.addElement("step",t),e=this.util.addElement("button",n,"input",["<",">"]).attr("type","button").property("value",(function(t){return t}));return e.on("click",(function(t,n){i.settings.play=!1,i.controls.play.input.property("value","play"),i.interval&&i.interval.stop(),"<"===this.value&&(i.settings.timepoint=0===i.settings.timepoint?i.set.visit.length-2:i.settings.timepoint-2),b.call(i),i.layout.timepoint.transition().style("opacity",1)})),{container:n,input:e}}function w(t){var i=this.util.addElement("footnotes",t,"small");return i.html(this.settings.footnotes.join("<br>")),i}function j(t){var i=this.util.addElement("controls",t),n=this.util.addElement("timepoint",i).classed("atm-controls-spacing",!0).append("span"),e=this.util.addElement("animation",i).classed("atm-controls-spacing",!0);return this.controls={play:S.call(this,e),step:A.call(this,e)},{controls:i,timepoint:n,animation:e,footnotes:w.call(this,i)}}function O(t){return this.util.addElement("charts",t)}function E(){c.call(this)}function k(){var t=this.util.addElement("main",d3.select(this.element)),i=j.call(this,t),n=O.call(this,t);return c.call(this,n),window.addEventListener("resize",E.bind(this)),a(a({main:t},i),{},{charts:n})}function P(){var t=this;this.data.forEach((function(i){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(n){i[n.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(n)?parseFloat(i[t.settings[n]]):i[t.settings[n]]}))}))}function C(t){var i;switch(t){case"visit":i=o(new Set(this.data.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,i){return t.replace(/.*\|/,"")-i.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:i=o(new Set(this.data.map((function(i){return i[t]}))).values()).sort()}return i}function I(){var t=this,i={};return i.stratification=C.call(this,"stratification"),i.id=C.call(this,"id"),i.visit=C.call(this,"visit"),i.visit_order=C.call(this,"visit_order"),i.day=C.call(this,"day"),i.measure=C.call(this,"measure"),i.timepoint=i.visit.map((function(i){return d3.median(t.data.filter((function(t){return t.visit===i})),(function(t){return t.day}))})),i}function T(t){var i;switch(t){case"stratification,visit":i=d3.groups(this.data,(function(t){return t.stratification}),(function(t){return t.visit}));break;case"measure,id":i=d3.groups(this.data,(function(t){return t.measure}),(function(t){return t.id}));break;default:i=d3.group(this.data,(function(i){return i[t]}))}return i}function D(){var t={};return t.stratification=T.call(this,"stratification"),t.stratification_visit=T.call(this,"stratification,visit"),t.id=T.call(this,"id"),t.visit=T.call(this,"visit"),t.measure=T.call(this,"measure"),t.measure_id=T.call(this,"measure,id"),t}function V(){var t=this;P.call(this),this.set=I.call(this),this.group=D.call(this),this.summary=d3.rollups(this.data,(function(t){return d3.sum(t,(function(t){return t.result}))}),(function(t){return t.stratification}),(function(t){return t.visit})),this.summary.tabular=Array(this.set.stratification.length*this.set.visit.length),this.summary.forEach((function(i,n){i[1].sort((function(i,n){return t.set.visit.indexOf(i[0])-t.set.visit.indexOf(n[0])})),i[1].forEach((function(e,r){e.stratum=i;var s={stratum:i[0],visit:e[0],value:e[1]};t.summary.tabular[n*t.set.visit.length+r]=s}))})),console.log(this.summary)}function G(t,i,n){var e=d3.scalePoint().domain(t).range([0,i.width]).padding([.5]);return n.append("g").attr("transform","translate(0,"+i.height+")").call(d3.axisBottom(e)),e}function L(t,i,n){var e=d3.scaleLinear().domain(t).range([i.height,0]);return n.append("g").call(d3.axisLeft(e)),e}function $(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d3.schemeSet2,n=d3.scaleOrdinal().domain(t).range(i);return n}function B(t,i,n){var e=this,r=d3.line().x((function(t){return n.x(t[0])})).y((function(t){return n.y(t[1])})),s=t.selectAll("path.line").data(i).join("path").classed("path",!0).attr("d",(function(t){var i=t[1][e.settings.timepoint],n=t[1].map((function(t,n){return n>=e.settings.timepoint?i:t}));return r(n)})).attr("stroke",(function(t){return n.color(t[0])})).style("stroke-width",4).style("fill","none");return s.lineGenerator=r,s}function F(t,i,n){var e=this,r=t.selectAll("g.point-group").data(i,(function(t){return t[0]})).join("g").classed("point-group",!0).attr("fill",(function(t){return n.color(t[0])}));return r.selectAll("circle.point").data((function(t){return t[1].slice(0,e.settings.timepoint+1)}),(function(t){return[t.stratum[0],t[0]].join("|")})).join("circle").classed("point",!0).attr("cx",(function(t){return n.x(t[0])})).attr("cy",(function(t){return n.y(t[1])})).attr("r",5).attr("stroke","white"),r}function M(t,i,n){var e=this;return t.selectAll("text.annotation").data(i).join("text").classed("annotation",!0).datum((function(t){var i=t[1].slice(0,e.settings.timepoint+1);return{name:t[0],value:i[i.length-1]}})).attr("transform",(function(t){return"translate("+n.x(t.value[0])+","+n.y(t.value[1])+")"})).attr("x",12).text((function(t){return t.name})).style("fill",(function(t){return n.color(t.name)})).style("font-size",15)}function U(t,i){var n=this;t.transition().duration(this.settings.speed).attr("d",(function(i){var e=i[1][n.settings.timepoint],r=i[1].map((function(t,i){return i>=n.settings.timepoint?e:t}));return t.lineGenerator(r)}))}function z(t,i){var n=this;return t.selectAll("circle.point").data((function(t){return t[1].slice(0,n.settings.timepoint+1)}),(function(t){return[t.stratum[0],t[0]].join("|")})).join((function(t){return t.append("circle").classed("point",!0).attr("r",5).attr("stroke","white").attr("cx",(function(t){var e=t.stratum[1][n.settings.timepoint-1];return i.x(e[0])})).attr("cy",(function(t){var e=t.stratum[1][n.settings.timepoint-1];return i.y(e[1])})).call((function(t){return t.transition().duration(n.settings.speed).attr("cx",(function(t){return i.x(t[0])})).attr("cy",(function(t){return i.y(t[1])}))}))})),t}function H(t,i){var n=this;t.datum((function(t){console.log(t);var i=t.value.stratum[1].slice(0,n.settings.timepoint+1);return{name:t.value.stratum[0],value:i[i.length-1]}})).transition().duration(this.settings.speed).attr("transform",(function(t){return"translate("+i.x(t.value[0])+","+i.y(t.value[1])+")"}))}function R(){var t=this;console.log(this.settings.timepoint),this.summary.forEach((function(i){i.subset=i[1].slice(0,t.settings.timepoint+1)}));var i,n={margin:i={top:25,right:70,bottom:25,left:50},width:800-i.left-i.right,height:400-i.top-i.bottom},e=function(t,i){return t.append("svg").attr("width",i.width+i.margin.left+i.margin.right).attr("height",i.height+i.margin.top+i.margin.bottom).append("g").attr("transform","translate("+i.margin.left+","+i.margin.top+")")}(this.layout.charts,n);this.scales={x:G(this.set.visit,n,e),y:L([0,d3.max(this.summary.tabular,(function(t){return t.value}))],n,e),color:$(this.set.stratification)};var r=B.call(this,e,this.summary,this.scales),s=F.call(this,e,this.summary,this.scales),a=M.call(this,e,this.summary,this.scales),o=function(){this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length?(this.interval.stop(),this.settings.timepoint=0,console.log(this.settings.timepoint)):(console.log(this.settings.timepoint),U.call(this,r,this.scales),z.call(this,s,this.scales),H.call(this,a,this.scales))};this.interval=d3.interval((function(){o.call(t)}),this.settings.speed)}return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={data:t,element:n,settings:Object.assign(e(),r),util:i};return s.settings.update.call(s),s.layout=k.call(s),V.call(s),R.call(s),s}}));
