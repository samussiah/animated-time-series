!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=e()}(this,(function(){"use strict";var t={addElement:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,e){return e};return i?e.selectAll("".concat(n,".atm-").concat(t,".atm-").concat(n)).data(i,a).join(n).classed("atm-".concat(t," atm-").concat(n),!0):e.append(n).classed("atm-".concat(t," atm-").concat(n),!0)}};function e(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function n(t){return function(t){if(Array.isArray(t))return i(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function a(t){return null===t.stratification_var&&(t.stratificaton_var=t.id_var),null===t.color_var&&(t.color_var=t.stratification_var),null===t.varLabels.stratification&&(t.varLabels.stratification=t.stratification_var),["ordinal","discrete"].includes(t.xType)||(t.xType="ordinal"),"ordinal"===t.xType?t.xVar="visit":"discrete"===t.xType&&(t.xVar="timepoint"),null===t.yLabel&&(t.yLabel="".concat(t.varLabels[t.yVar]," - ").concat(t.aggregateLabels[t.aggregate])),["mean","geomean"].includes(t.aggregate)||(t.displayCIs=!1),t.alpha<=0|t.alpha>=1&&(t.alpha=.05),!0===t.displayCIs&&(t.yLabel="".concat(t.yLabel," (").concat(100*(1-t.alpha),"% CI)")),t.stratification_var!==t.color_var&&(t.annotate=!1,t.displayLegend=!0),t.footnotes=t.footnotes.map((function(e){return e.replace("[aggregate]",t.aggregate).replace("[outcome]",t.outcome)})),t}function r(){var t;return e(t={update:a,stratification_var:null,color_var:null,id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",varLabels:{stratification:null,color_var:null,id:"Participant ID",visit:"Visit",visit_order:"Visit Order",day:"Study Day",measure:"Measure",result:"Result"},measureOrder:[],measureYTicks:[],xType:"ordinal",xVar:"visit",xLabel:"Visit",rotateXTickLabels:!0,yType:"continuous",yVar:"result",yLabel:null,aggregate:"mean",aggregateLabels:{mean:"Mean",median:"Median",geomean:"Geometric Mean",deviation:"Standard Deviation"},displayCIs:!0,alpha:.05,colorScheme:d3.schemeSet2,displayLegend:!1,annotate:!0,offset:7.5,pointRadius:5,strokeWidth:3,fontSize:15,fontWeight:"bold",play:!0,timepoint:0,measureIndex:0},"measureOrder",[]),e(t,"speed",1e3),e(t,"pause",5e3),e(t,"width",null),e(t,"widthFactor",2),e(t,"height",null),e(t,"heightFactor",2),e(t,"margin",{top:50,right:100,bottom:100,left:75}),e(t,"footnotes",[]),t}function s(t){return this.util.addElement("charts",t)}function o(){var t=this.util.addElement("main",d3.select(this.element)),e=this.util.addElement("legend",t),n=s.call(this,t),i=function(t,e){var n=t.node().clientWidth/e.widthFactor;return{width:n,height:n/e.heightFactor}}(n,this.settings),a=i.width,r=i.height;return this.settings.width=a,this.settings.height=r,this.settings.dimensions={width:a,height:r,margin:this.settings.margin,widthAdj:a-this.settings.margin.left-this.settings.margin.right,heightAdj:r-this.settings.margin.top-this.settings.margin.bottom},{main:t,legend:e,charts:n}}function l(t,e){var n=t.length,i=t.map((function(t){var n={};return Object.keys(e).filter((function(t){return/_var$/.test(t)})).forEach((function(i){n[i.replace(/_var$/,"")]=["visit_order_var","day_var","result_var"].includes(i)?parseFloat(t[e[i]]):t[e[i]]})),n})).filter((function(t){return!isNaN(t.result)})).sort((function(t,e){return(t.measure<e.measure?-1:e.measure<t.measure?1:0)|t.visit_order-e.visit_order|(t.stratification<e.stratification?-1:e.stratification<t.stratification?1:0)|(t.id<e.id?-1:e.id<t.id?1:0)})),a=n-i.length;return a>0&&console.warn("".concat(a," rows without results removed.")),i}function u(t,e){var i;switch(t){case"visit":i=n(new Set(e.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,e){return t.replace(/.*\|/,"")-e.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:i=n(new Set(e.map((function(e){return e[t]}))).values()).sort()}return i}function c(t,e){var n={};return n.id=u("id",t.cleansed),n.stratification=u("stratification",t.cleansed),n.color=u("color",t.cleansed),n.visit=u("visit",t.cleansed),n.visit_order=u("visit_order",t.cleansed),n.day=u("day",t.cleansed),n.measure=u("measure",t.cleansed),null!==e.measureOrder&&Array.isArray(e.measureOrder)&&n.measure.sort((function(t,n){var i=e.measureOrder.findIndex((function(e){return e===t})),a=e.measureOrder.findIndex((function(t){return t===n}));return~i&&~a?i-a:~i||~a||t<n?-1:n<t?1:0})),n.strata=n.stratification.reduce((function(n,i){var a=t.raw.filter((function(t){return t[e.stratification_var]===i})).map((function(t){return t[e.id_var]})),r=new Set(a).size;return n[i]=r,n}),{}),n.timepoint=n.visit.map((function(e){return d3.median(t.cleansed.filter((function(t){return t.visit===e})),(function(t){return t.day}))})),n.offsets=d3.range(Math.ceil(-n.stratification.length/2)*e.offset+e.offset/2*!(n.stratification.length%2),Math.ceil(n.stratification.length/2)*e.offset+e.offset/2*!(n.stratification.length%2),e.offset),n}function d(t,e,n){var i=function(t,e,n){var i=t[0].measure,a=t[0].stratification,r=n.get(i),s=t.map((function(t){return t.result})).sort((function(t,e){return t-e}));if(["geomean"].includes(e.aggregate)){var o=0;s=s.map((function(t){return t<=0&&(t=r,o++),t})),o>0&&console.warn("".concat(o," non-positive ").concat(i," results for ").concat(a," set to ").concat(r,", the smallest positive result."))}var l=s.filter((function(t){return t!==1/0}));return l.length<s.length&&console.warn("".concat(s.length-l.length," infinite ").concat(i," results for ").concat(a," removed.")),l}(t,e,n),a=(jStat(i),t.length),r=d3.mean(i),s=d3.deviation(i),o=jStat.tci(r,e.alpha,i),l=d3.min(i),u=d3.median(i),c=d3.max(i),d=jStat.geomean(i),f={n:a,mean:r,deviation:s,mean_ci:o,min:l,median:u,max:c,geomean:d,geomean_ci:jStat.tci(Math.log(d),e.alpha,i.map((function(t){return Math.log(t)}))).map((function(t){return Math.exp(t)}))};return{data:t,stats:f,value:f[e.aggregate]}}function f(t,e,i){var a=d3.rollup(t,(function(t){return d3.min(t.map((function(t){return t.result})).filter((function(t){return t>0})))}),(function(t){return t.measure}));return function(t,e,i){var a=structuredClone(t);return a.forEach((function(t,i){var a=Array(e.stratification.length*e.visit.length);e.stratification.forEach((function(i,r){var s=t[1].find((function(t){return t[0]===i}));void 0===s&&(s=[i,e.visit.map((function(t){return[t,{data:[],value:null}]}))],t[1].splice(r,0,s)),s&&s[1].sort((function(t,n){return e.visit.indexOf(t[0])-e.visit.indexOf(n[0])}));try{s.color_value=s[1][0][1].data[0].color}catch(e){console.warn("Missing [ color ] identified:"),console.log(t),console.log(i),console.log(s[1][0][1])}s.offset=e.offsets[r],e.visit.forEach((function(o,l){var u=s[1].find((function(t){return t[0]===o}));void 0===u&&(console.log(t[0],i,o),console.log(s[1][l][0]),u=n(l>0?s[1][l-1]:s[1][l]),console.log(u),s[1].splice(l,0,u)),u.visit=u[0],u.index=e.visit.findIndex((function(t){return t===u[0]})),u.visit_order=e.visit_order[u.index],u.timepoint=e.timepoint[u.index],u.stratum=s;var c={measure:t[0],stratum:s[0],visit:u[0],value:u[0]===o?u[1].value:null};a[r*e.visit.length+l]=c}))})),t.tabular=a.filter((function(t){return!0})),t.visits=n(new Set(t.tabular.map((function(t){return t.visit}))).values())})),a}(d3.rollups(t,(function(t){return d(t,i,a)}),(function(t){return t.measure}),(function(t){return t.stratification}),(function(t){return t.visit})).sort((function(t,n){return e.measure.indexOf(t[0])-e.measure.indexOf(n[0])})),e)}function g(){this.data.cleansed=l.call(this,this.data.raw,this.settings),this.data.set=c.call(this,this.data,this.settings),this.data.nested=f.call(this,this.data.cleansed,this.data.set,this.settings)}function h(t,e){return{index:t,visit:e.visit[t],visit_order:e.visit_order[t],timepoint:e.timepoint[t]}}function m(t,e,n){var i=t.tabular.map((function(t){return t.value}));return n.displayCIs&&t[1].map((function(t){return t[1]})).flat().map((function(t){return t[1].stats["".concat(n.aggregate,"_ci")]})).flat().forEach((function(t){return i.push(t)})),d3.scaleLinear().domain([d3.min(i),d3.max(i)]).nice().range(e)}function p(t,e,n){var i={index:n.measureIndex,data:t[n.measureIndex],scales:e};return i.key=i.data[0],i.scales.y=m(i.data,[n.dimensions.heightAdj,0],n),i.yTicks=n.measureYTicks.find((function(t){return t.key===i.key})),i}var v={x:function(t,e,n){var i;if("ordinal"===n)i=d3.scalePoint().domain(t).range(e).padding([.5]);else{var a=d3.extent(t),r=a[1]-a[0];i=d3.scaleLinear().domain([a[0]-.05*r,a[1]+.05*r]).range(e)}return i},y:m,color:function(t,e){return d3.scaleOrdinal().domain(t).range(e)}};function y(t,e){var n=this,i=t.selectAll("div.atm-legend-item").data(e.domain()).join("div").classed("atm-legend-item",!0).append("p").classed("atm-legend-item__content",!0);i.append("span").classed("atm-legend-item__symbol",!0).style("background",(function(t,n){return e(t)})),i.insert("text").classed("atm-legend-item__text",!0).text((function(t,e){return"".concat(t," (n=").concat(n.data.set.strata[t],")")}))}function x(t,e){var n=this,i=this.layout.charts.append("div").classed("atm-container atm-div",!0),a=this.util.addElement("header",i,"h3").text(t).style("display","none"),r=this.util.addElement("time-series__svg",i,"svg").attr("width",e.width).attr("height",e.height).style("display","none"),s=this.util.addElement("time-series__g",r,"g").attr("transform","translate("+e.margin.left+","+e.margin.top+")").style("display","none"),o=i.style("width","0%").transition().duration(this.settings.speed).style("width","50%");return{canvas:s,mainTransition:o,transitionEnd:function(){a.style("display",null),r.style("display",null),s.style("display",null),i.style("opacity",0).transition().duration(n.settings.speed).style("opacity",1)}}}function _(t,e,n,i,a){var r=this,s=t.append("g").classed("atm-axis",!0).attr("transform","translate(0,"+n.heightAdj+")");return"ordinal"===i?s.call(d3.axisBottom(e)):s.call(d3.axisBottom(e).tickValues(a.timepoint).tickFormat((function(t,e){return a.visit[e]}))),this.settings.rotateXTickLabels&&s.selectAll("text").style("text-anchor","end").attr("transform","rotate(-45)").attr("dx","-.8em").attr("dy",".15em"),s.label=t.append("g").call((function(t){t.append("text").attr("class","axis-label").attr("text-anchor","middle").attr("font-size",16).attr("font-weight","bold").attr("x",n.widthAdj/2).attr("y",n.heightAdj+n.margin.bottom-32).text(r.settings.xLabel)})),s}function b(t,e,n,i){var a=this,r=t.append("g").classed("atm-axis",!0);return void 0===i?r.call(d3.axisLeft(e)):r.call(d3.axisLeft(e).tickValues(i.value)),r.gridLines=t.append("g").call((function(t){t.attr("class","grid-lines").selectAll("line").data(e.ticks()).join("line").attr("x1",0).attr("x2",n.widthAdj).attr("y1",(function(t){return e(t)})).attr("y2",(function(t){return e(t)}))})),r.label=t.append("g").call((function(t){t.append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("text-anchor","middle").attr("font-size",16).attr("font-weight","bold").attr("x",-n.heightAdj/2).attr("y",-(n.margin.left-32)).text(a.settings.yLabel)})),r}function w(t){var e=this.settings.dimensions,n=x.call(this,t.data[0],e),i=n.canvas;return{canvas:i,mainTransition:n.mainTransition,transitionEnd:n.transitionEnd,xAxis:_.call(this,i,t.scales.x,e,this.settings.xType,this.data.set,t.visits),yAxis:b.call(this,i,t.scales.y,e,t.yTicks)}}function A(t,e,n){var i=this,a=d3.line().x((function(t){return n.x(t[i.settings.xVar])+t.stratum.offset})).y((function(t){return n.y(t[1].value)})),r=t.selectAll("path.line").data(e).join("path").classed("line",!0);return r.attr("d",(function(t){var e=t[1][i.settings.timepoint],n=t[1].map((function(t,n){return n>=i.settings.timepoint?e:t}));return a(n)})).attr("stroke",(function(t){return n.color(t.color_value)})).attr("stroke-width",this.settings.strokeWidth).attr("stroke-opacity",.75).attr("fill","none"),r.lineGenerator=a,r}function j(t,e,n){var i=this,a=t.selectAll("g.point-group").data(e,(function(t){return t[0]})).join("g").classed("point-group",!0);return a.attr("fill",(function(t){return n.color(t.color_value)})),a.selectAll("circle.point").data((function(t){return t[1].slice(0,i.settings.timepoint+1)}),(function(t,e){return[t.stratum[0],e].join("|")})).join("circle").classed("point",!0).attr("cx",(function(t){return n.x(t[i.settings.xVar])+t.stratum.offset})).attr("cy",(function(t){return n.y(t[1].value)})).attr("stroke","white").attr("r",0).transition().duration(this.settings.speed/2).attr("r",this.settings.pointRadius),a}function I(t,e,n){var i=this,a=t.selectAll("g.ci-group").data(e,(function(t){return t[0]})).join("g").classed("ci-group",!0);return a.attr("stroke",(function(t){return n.color(t.color_value)})).attr("stroke-width",this.settings.strokeWidth),a.selectAll("line.ci").data((function(t){return t[1].slice(0,i.settings.timepoint+1)}),(function(t,e){return[t.stratum[0],e].join("|")})).join("line").classed("ci",!0).attr("x1",(function(t){return n.x(t[i.settings.xVar])+t.stratum.offset})).attr("x2",(function(t){return n.x(t[i.settings.xVar])+t.stratum.offset})).attr("y1",(function(t){return n.y(t[1].value)})).attr("y2",(function(t){return n.y(t[1].value)})).attr("stroke-linecap","round").transition().duration(this.settings.speed/4).delay(this.settings.speed/2).attr("y1",(function(t){return n.y(t[1].stats["".concat(i.settings.aggregate,"_ci")][0])})).attr("y2",(function(t){return n.y(t[1].stats["".concat(i.settings.aggregate,"_ci")][1])})),a}function k(t){var e=this.settings.fontSize;t.sort((function(t,e){return e.y-t.y})).forEach((function(n,i){if(i>0){var a=t[i-1].y-n.y;a<e&&(n.y=n.y-(e-a))}}))}function S(t,e,n){var i=this,a=t.selectAll("text.annotation").data(e).join("text").classed("annotation",!0);return a.datum((function(t){var e=t[1][i.settings.timepoint];return{x:n.x(e[i.settings.xVar]),y:n.y(e[1].value),color:n.color(t[0]),text:t[0],stratum:t}})),k.call(this,a.data()),a.attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y})).attr("dx",this.settings.offset*this.data.set.stratification.length/2+3).attr("dy",this.settings.fontSize/3).attr("fill",(function(t){return t.color})).style("font-weight",this.settings.fontWeight).text((function(t){return t.text})).attr("font-size",0),a.transition().duration(this.settings.speed/this.data.set.stratification.length).delay((function(t,e){return e*i.settings.speed/i.data.set.stratification.length})).attr("font-size",this.settings.fontSize),a}function L(t){var e=t.data[1];t.lines=A.call(this,t.layout.canvas,e,t.scales),t.points=j.call(this,t.layout.canvas,e,t.scales),this.settings.displayCIs&&(t.CIs=I.call(this,t.layout.canvas,e,t.scales)),this.settings.annotate&&(t.annotations=S.call(this,t.layout.canvas,e,t.scales))}function T(t,e){var n=this;t.transition().duration(this.settings.speed-.25*this.settings.speed*this.settings.displayCIs).attr("d",(function(e){var i=e[1][n.settings.timepoint],a=e[1].map((function(t,e){return e>=n.settings.timepoint?i:t}));return t.lineGenerator(a)}))}function V(t,e){var n=this;return t.selectAll("circle.point").data((function(t){return t[1].slice(0,n.settings.timepoint+1)}),(function(t,e){return[t.stratum[0],e].join("|")})).join((function(t){return t.append("circle").classed("point",!0).attr("r",n.settings.pointRadius).attr("stroke","white").attr("cx",(function(t){var i=t.stratum[1][n.settings.timepoint-1];return e.x(i[n.settings.xVar])+i.stratum.offset})).attr("cy",(function(t){var i=t.stratum[1][n.settings.timepoint-1];return e.y(i[1].value)})).call((function(t){return t.transition().duration(n.settings.speed-.25*n.settings.speed*n.settings.displayCIs).attr("cx",(function(t){return e.x(t[n.settings.xVar])+t.stratum.offset})).attr("cy",(function(t){return e.y(t[1].value)}))}))})),t}function E(t,e){var n=this;return t.selectAll("line.ci").data((function(t){return t[1].slice(0,n.settings.timepoint+1)}),(function(t,e){return[t.stratum[0],e].join("|")})).join((function(t){return t.append("line").classed("ci",!0).attr("x1",(function(t){return e.x(t[n.settings.xVar])+t.stratum.offset})).attr("x2",(function(t){return e.x(t[n.settings.xVar])+t.stratum.offset})).attr("y1",(function(t){return e.y(t[1].value)})).attr("y2",(function(t){return e.y(t[1].value)})).call((function(t){return t.transition().duration(.25*n.settings.speed).delay(.75*n.settings.speed).attr("y1",(function(t){return e.y(t[1].stats["".concat(n.settings.aggregate,"_ci")][0])})).attr("y2",(function(t){return e.y(t[1].stats["".concat(n.settings.aggregate,"_ci")][1])})).attr("stroke-linecap","round")}))})),t}function O(t,e){var n=this;t.datum((function(t){var i=t.stratum[1][n.settings.timepoint];return{x:e.x(i[n.settings.xVar]),y:e.y(i[1].value),color:e.color(t.stratum[0]),text:t.stratum[0],stratum:t.stratum}})),k.call(this,t.data()),t.transition().duration(this.settings.speed-.25*this.settings.speed*this.settings.displayCIs).attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y}))}function C(t){var e=this;this.settings.timepoint++,this.settings.timepoint>=this.data.set.visit.length?(this.interval.stop(),this.settings.measureIndex++,d3.timeout((function(){e.settings.timepoint=0,e.timepoint=h(e.settings.timepoint,e.data.set),e.settings.measureIndex<e.data.set.measure.length&&(e.measure=p(e.data.nested,e.scales,e.settings),e.measure.layout=w.call(e,e.measure),e.measure.layout.mainTransition.on("end",(function(){e.measure.layout.transitionEnd(),L.call(e,e.measure),d3.timeout((function(){e.interval=d3.interval((function(){C.call(e,e.measure)}),e.settings.speed)}),2*e.settings.speed)})))}),this.settings.pause)):(this.timepoint=h(this.settings.timepoint,this.data.set),T.call(this,t.lines,t.scales),V.call(this,t.points,t.scales),this.settings.displayCIs&&E.call(this,t.CIs,t.scales),this.settings.annotate&&O.call(this,t.annotations,t.scales))}function M(){var t=this;this.timepoint=h(this.settings.timepoint,this.data.set),this.scales={x:v.x(this.data.set[this.settings.xVar],[0,this.settings.dimensions.widthAdj],this.settings.xType),color:v.color(this.data.set.color,this.settings.colorScheme)},this.settings.displayLegend&&y.call(this,this.layout.legend,this.scales.color),this.measure=p(this.data.nested,this.scales,this.settings),this.measure.layout=w.call(this,this.measure),this.measure.layout.mainTransition.on("end",(function(){t.measure.layout.transitionEnd(),L.call(t,t.measure),d3.timeout((function(){t.interval=d3.interval((function(){C.call(t,t.measure)}),t.settings.speed)}),2*t.settings.speed)}))}return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a={data:{raw:e},element:n,settings:r().update(Object.assign(r(),i)),util:t};return a.layout=o.call(a),g.call(a),M.call(a),a}}));
