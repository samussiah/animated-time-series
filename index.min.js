!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=e()}(this,(function(){"use strict";var t={id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",baseline_var:"BASE",change_var:"CHG",percent_change_var:"PCHG",aggregate:"mean",speed:2500,loop_time:5e3};function e(t,e,i){return t.find((function(t){return t[e]===i}))}var i={getDatum:e,getValue:function(t,i,n,a){var r=e(t,i,n);return r?r[a]:null}};function n(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",n=e.append(i).classed("atm-".concat(t),!0);return n}function a(){var t=n("main",d3.select(this.element));return this.settings.width=t.node().clientWidth/2,this.settings.widthTimeSeries=2*this.settings.width/3-10,this.settings.widthPieChart=1*this.settings.width/3-10,this.settings.height=this.settings.width/3,this.settings.margin={top:30,right:30,bottom:40,left:40},{main:t,timepoint:n("timepoint",t,"h2"),charts:n("charts",t)}}function r(t){return function(t){if(Array.isArray(t))return s(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return s(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);"Object"===i&&t.constructor&&(i=t.constructor.name);if("Map"===i||"Set"===i)return Array.from(t);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return s(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function o(){var t=this;this.data.every((function(t){return/^-?\d+\.?\d*$/.test(t.id)||/^-?\d*\.?\d+$/.test(t.id)}));this.data.forEach((function(e){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(i){e[i.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(i)?parseFloat(e[t.settings[i]]):e[t.settings[i]]}))}))}function c(){return{id:new Set(this.data.map((function(t){return t.id}))),visit:new Set(this.data.map((function(t){return t.visit}))),visit_order:new Set(this.data.map((function(t){return t.visit_order}))),day:new Set(this.data.map((function(t){return t.day}))),measure:new Set(this.data.map((function(t){return t.measure})))}}function l(){return{id:d3.group(this.data,(function(t){return t.id})),visit:d3.group(this.data,(function(t){return t.visit})),measure:d3.group(this.data,(function(t){return t.measure}))}}function u(){var t=this;o.call(this),this.data.sets=c.call(this),this.data.visits=r(new Set(this.data.map((function(t){return"".concat(t.visit_order,"|").concat(t.visit)}))).values()).map((function(t){return t.split("|")})).sort((function(t,e){return t[0]-e[0]})).map((function(t){return t[1]})),this.data.timepoints=this.data.visits.map((function(e){return d3.median(t.data.filter((function(t){return t.visit===e})),(function(t){return t.day}))})),this.data.groups=l.call(this)}function d(t){return d3.scaleLinear().domain(d3.extent(t,(function(t){return t.day}))).rangeRound([this.settings.margin.left,this.settings.widthTimeSeries-this.settings.margin.right])}function h(t){return d3.scaleLinear().domain(d3.extent(t,(function(t){return t.result}))).rangeRound([this.settings.height-this.settings.margin.bottom,this.settings.margin.top])}function g(t){var e=d3.max(t,(function(t){return Math.abs(t.change)}));return d3.scaleSequential().domain([-e,e]).interpolator(d3.interpolateViridis)}function f(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,i=document.createElement("canvas");i.width=e,i.height=1;for(var n=i.getContext("2d"),a=0;a<e;++a)n.fillStyle=t(a/(e-1)),n.fillRect(a,0,1,1);return i}function p(t,e){e.toLowerCase().replace(/[^a-z0-9_]/g,"-");var i=n("container",this.containers.charts),a=n("header",i,"h3").text(e),r=n("legend",i);r.node().appendChild(function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.color,n=e.title,a=e.tickSize,r=void 0===a?6:a,s=e.width,o=void 0===s?320:s,c=e.height,l=void 0===c?44+r:c,u=e.marginTop,d=void 0===u?18:u,h=e.marginRight,g=void 0===h?0:h,p=e.marginBottom,v=void 0===p?16+r:p,m=e.marginLeft,y=void 0===m?0:m,x=e.ticks,S=void 0===x?o/64:x,A=e.tickFormat,w=e.tickValues,k=d3.create("svg").attr("width",o).attr("height",l).attr("viewBox",[0,0,o,l]).style("overflow","visible").style("display","block"),b=function(t){return t.selectAll(".tick line").attr("y1",d+v-l)};if(i.interpolate){var _=Math.min(i.domain().length,i.range().length);t=i.copy().rangeRound(d3.quantize(d3.interpolate(y,o-g),_)),k.append("image").attr("x",y).attr("y",d).attr("width",o-y-g).attr("height",l-d-v).attr("preserveAspectRatio","none").attr("xlink:href",f.call(this,i.copy().domain(d3.quantize(d3.interpolate(0,1),_))).toDataURL())}else if(i.interpolator){if(t=Object.assign(i.copy().interpolator(d3.interpolateRound(y,o-g)),{range:function(){return[y,o-g]}}),k.append("image").attr("x",y).attr("y",d).attr("width",o-y-g).attr("height",l-d-v).attr("preserveAspectRatio","none").attr("xlink:href",f.call(this,i.interpolator()).toDataURL()),!t.ticks){if(void 0===w){var C=Math.round(S+1);w=d3.range(C).map((function(t){return d3.quantile(i.domain(),t/(C-1))}))}"function"!=typeof A&&(A=d3.format(void 0===A?",f":A))}}else if(i.invertExtent){var I=i.thresholds?i.thresholds():i.quantiles?i.quantiles():i.domain(),T=void 0===A?function(t){return t}:"string"==typeof A?d3.format(A):A;t=d3.scaleLinear().domain([-1,i.range().length-1]).rangeRound([y,o-g]),k.append("g").selectAll("rect").data(i.range()).join("rect").attr("x",(function(e,i){return t(i-1)})).attr("y",d).attr("width",(function(e,i){return t(i)-t(i-1)})).attr("height",l-d-v).attr("fill",(function(t){return t})),w=d3.range(I.length),A=function(t){return T(I[t],t)}}else t=d3.scaleBand().domain(i.domain()).rangeRound([y,o-g]),k.append("g").selectAll("rect").data(i.domain()).join("rect").attr("x",t).attr("y",d).attr("width",Math.max(0,t.bandwidth()-1)).attr("height",l-d-v).attr("fill",i),b=function(){};return k.append("g").attr("transform","translate(0,".concat(l-v,")")).call(d3.axisBottom(t).ticks(S,"string"==typeof A?A:void 0).tickFormat("function"==typeof A?A:void 0).tickSize(r).tickValues(w)).call(b).call((function(t){return t.select(".domain").remove()})).call((function(t){t.append("text").attr("x",y).attr("y",d+v-l-6).attr("fill","currentColor").attr("text-anchor","start").attr("font-weight","bold").attr("font-size","1rem").text("-"),t.append("text").attr("x",o/2).attr("y",d+v-l-6).attr("fill","currentColor").attr("text-anchor","middle").attr("font-weight","bold").attr("font-size","1rem").text(n),t.append("text").attr("x",o-g).attr("y",d+v-l-6).attr("fill","currentColor").attr("text-anchor","end").attr("font-weight","bold").attr("font-size","1rem").text("+")})),k.node()}({color:t.colorScale,title:"Change from Baseline"}));var s=n("time-series",i).classed("atm-svg-container",!0);s.svg=n("time-series__svg",s,"svg").attr("width",this.settings.widthTimeSeries).attr("height",this.settings.height);var o=n("x-axis",s.svg,"g"),c=n("y-axis",s.svg,"g"),l=n("canvas",s.svg,"g"),u=n("lines",l,"g"),d=n("points",l,"g"),h=n("lines-aggregate",l,"g"),g=n("points-aggregate",l,"g"),p=n("pie-chart",i).classed("atm-svg-container",!0);return p.header=n("pie-chart__header",p).text("Participant Breakdown"),p.svg=n("pie-chart__svg",p,"svg").attr("width",this.settings.widthPieChart).attr("height",this.settings.height),p.g=n("pie-chart__g",p.svg,"g").attr("transform","translate(".concat(this.settings.widthPieChart/2,",").concat(this.settings.height/2,")")).attr("text-anchor","middle"),{main:i,header:a,legend:r,timeSeries:s,xAxis:o,yAxis:c,canvas:l,lines:u,points:d,linesAggregate:h,pointsAggregate:g,pieChart:p}}function v(t){var e=this;return t.containers.xAxis.attr("transform","translate(0,".concat(this.settings.height-this.settings.margin.bottom,")")).call(d3.axisBottom(t.xScale).ticks(this.settings.widthTimeSeries/80)).call((function(t){return t.append("text").attr("x",(e.settings.widthTimeSeries-e.settings.margin.left)/2).attr("y",e.settings.margin.bottom/2+4).attr("fill","currentColor").attr("text-anchor","center").attr("alignment-baseline","hanging").text("Study Day")}))}function m(t){var e=this;return t.containers.yAxis.attr("transform","translate(".concat(this.settings.margin.left,",0)")).call(d3.axisLeft(t.yScale)).call((function(t){return t.select(".domain").remove()})).call((function(i){return i.append("g").attr("stroke","currentColor").attr("stroke-opacity",.1).selectAll("line").data(t.yScale.ticks()).join("line").attr("y1",(function(e){return.5+t.yScale(e)})).attr("y2",(function(e){return.5+t.yScale(e)})).attr("x1",0).attr("x2",e.settings.widthTimeSeries-e.settings.margin.right-e.settings.margin.left)}))}function y(t){return t.containers.lines.selectAll("line").data(t.ids,(function(t){return t[0]})).join("line").attr("stroke-opacity",0)}function x(t){var e=this;return t.containers.points.selectAll("circle").data(t.ids,(function(t){return t[0]})).join("circle").attr("cx",(function(i){return t.xScale(e.util.getValue(i[1],"visit",e.visit,"day"))})).attr("cy",(function(i){return t.yScale(e.util.getValue(i[1],"visit",e.visit,"result"))})).attr("r",1).attr("fill",t.colorScale(0)).attr("fill-opacity",.25).attr("stroke",t.colorScale(0)).attr("stroke-opacity",.5).style("display",(function(t){return e.util.getDatum(t[1],"visit",e.visit)?null:"none"}))}function S(t){var e=this;return t.containers.linesAggregate.selectAll("line.atm-line-aggregate").data(d3.pairs(t.aggregate)).join("line").classed("atm-line-aggregate",!0).attr("x1",(function(i,n){return t.xScale(e.data.timepoints[n])})).attr("x2",(function(i,n){return t.xScale(e.data.timepoints[n])})).attr("y1",(function(e){return t.yScale(e[0][1])})).attr("y2",(function(e){return t.yScale(e[0][1])})).attr("stroke",(function(e){return t.colorScale(e[1][1]-e[0][1])})).attr("stroke-width",3)}function A(t){return t.containers.pointsAggregate.append("circle").datum(t.aggregate).classed("atm-point-aggregate",!0).attr("cx",t.xScale(this.timepoint)).attr("cy",(function(e){return t.yScale(e[0][1])})).attr("r",4).attr("fill",t.colorScale(0)).attr("fill-opacity",1).attr("stroke","black").attr("stroke-opacity",1)}function w(t){return t.containers.pieChart.g.append("g").selectAll("path").data(t.pieData).join("path").attr("d",t.arc).attr("fill",(function(e){return t.pieColor(e.data)})).attr("stroke","black").attr("stroke-width","2px").style("opacity",.7)}function k(t){return t.containers.pieChart.g.append("g").selectAll("text").data(t.pieData).join("text").attr("transform",(function(e){return"translate(".concat(t.arcLabel.centroid(e),")")})).call((function(t){return t.append("tspan").attr("y","-0.4em").attr("font-weight","bold").text((function(t,e){return 0===e?"Increase":1===e?"No change":"Decrease"}))})).call((function(t){return t.append("tspan").attr("x",0).attr("y","0.7em").attr("fill-opacity",.7).text((function(t){return d3.format(".1%")(t.data)}))}))}function b(t){t.xAxis=v.call(this,t),t.yAxis=m.call(this,t),t.lines=y.call(this,t),t.points=x.call(this,t),t.linesAggregate=S.call(this,t),t.pointsAggregate=A.call(this,t),t.arc=d3.arc().innerRadius(0).outerRadius(this.settings.widthPieChart/2-4),t.arcLabel=d3.arc().innerRadius(.7*(this.settings.widthPieChart/2-4)).outerRadius(.7*(this.settings.widthPieChart/2-4)),t.participantBreakdown=t.pct[0][1],t.pieColor=d3.scaleOrdinal().domain(t.participantBreakdown).range(["#bcdf27","#21918d","#482575"]),t.pieGenerator=d3.pie().value((function(t){return t})).sort(null),t.pieData=t.pieGenerator(t.participantBreakdown),t.pieChart=w.call(this,t),t.pieText=k.call(this,t)}function _(t){var e=this;t.lines.each((function(i){var n=i[1].find((function(t){return t.visit===e.visit})),a=i[1].findIndex((function(t){return t.visit===e.visit})),r=i[1].slice(0,a).pop(),s=d3.select(this);r&&n?s.attr("x1",t.xScale(r.ADY)).attr("y1",t.yScale(r.AVAL)).attr("x2",t.xScale(r.ADY)).attr("y2",t.yScale(r.AVAL)).attr("stroke",t.colorScale(n.AVAL-r.AVAL)).attr("stroke-opacity",.25).transition().ease(d3.easeQuad).duration(2*e.settings.speed/5).attr("x2",t.xScale(n.ADY)).attr("y2",t.yScale(n.AVAL)):s.transition().duration(2*e.settings.speed/5).attr("stroke-opacity",0)}))}function C(t){var e=this;t.points.each((function(i){var n=i[1].find((function(t){return t.visit===e.visit})),a=(i[1].find((function(t){return!!t.result})),d3.select(this));0!==e.visit||n?"none"===a.style("display")&&n&&a.attr("cx",t.xScale(n.day)).attr("cy",t.yScale(n.result)):a.style("display","none");var r=a.transition().ease(d3.easeQuad).duration(2*e.settings.speed/5).delay(1*e.settings.speed/5);n?r.attr("cx",t.xScale(n.day)).attr("cy",t.yScale(n.result)).attr("fill",t.colorScale(n.change)).attr("fill-opacity",.25).attr("stroke",t.colorScale(n.change)).style("display",null):r.attr("fill-opacity",.25).attr("stroke-opacity",.5)}))}function I(t){var e=this;if(t.linesAggregate.filter((function(t,i){return i===e.visitIndex-1})).transition().duration(2*this.settings.speed/5).delay(1*this.settings.speed/5).attr("x2",(function(i,n){return t.xScale(e.timepoint)})).attr("y2",(function(e){return t.yScale(e[1][1])})),0===this.visitIndex){var i=this.settings.speed/this.data.visits.length;t.linesAggregate.transition().duration(i).delay((function(t,n){return e.settings.speed-i*n})).attr("x2",(function(){return this.getAttribute("x1")})).attr("y2",(function(){return this.getAttribute("y1")}))}}function T(t){var e=this;if(this.visitIndex>0?t.pointsAggregate.transition().ease(d3.easeQuad).duration(2*this.settings.speed/5).delay(2*this.settings.speed/5).attr("cx",t.xScale(this.timepoint)).attr("cy",(function(i){return t.yScale(i[e.visitIndex][1])})).attr("fill",(function(i,n){return t.colorScale(i[e.visitIndex][2])})):t.pointsAggregate.attr("cx",t.xScale(this.timepoint)).attr("cy",(function(e){return t.yScale(e[0][1])})).attr("fill",t.colorScale(0)),t.pointsAggregate.clone().classed("atm-clone",!0),0===this.visitIndex){var i=this.settings.speed/this.data.visits.length;t.containers.canvas.selectAll(".atm-clone").transition().duration(i).delay((function(t,e){return i*e})).attr("fill-opacity",0).attr("stroke-opacity",0).remove()}}function D(t){t.pieChart.data(t.pieData).transition().duration(this.settings.speed/2).attrTween("d",(function(e){var i=d3.interpolate(this._current,e);return this._current=i(0),function(e){return t.arc(i(e))}}))}function L(t){t.pieText.data(t.pieData).transition().duration(this.settings.speed/2).attrTween("transform",(function(e){var i=d3.interpolate(this._current,e);return this._current=i(0),function(e){return"translate(".concat(t.arcLabel.centroid(i(e)),")")}})),t.pieText.select("tspan:last-child").text((function(t){return d3.format(".1%")(t.data)}))}function R(){var t=this;this.visitIndex=this.visitIndex>=this.data.visits.length-1?0:this.visitIndex+1,this.visitIndex===this.data.visits.length-1&&(this.interval.stop(),d3.timeout((function(e){t.interval=d3.interval((function(){R.call(t)}),t.settings.speed)}),this.settings.loop_time)),this.visit=this.data.visits[this.visitIndex],this.timepoint=this.data.timepoints[this.visitIndex],this.containers.timepoint.transition().delay(this.settings.speed/2).text(this.visit),this.data.groups.measure.forEach((function(e,i){_.call(t,e),C.call(t,e),I.call(t,e),T.call(t,e),e.participantBreakdown=e.pct[t.visitIndex][1],e.pieColor=d3.scaleOrdinal().domain(e.participantBreakdown).range(["#bcdf27","#21918d","#482575"]),e.pieData=e.pieGenerator(e.participantBreakdown),D.call(t,e),L.call(t,e)}))}function j(){var t=this;this.visitIndex=0,this.visit=this.data.visits[this.visitIndex],this.timepoint=this.data.timepoints[this.visitIndex],this.containers.timepoint.text(this.visit),this.xScale=d.call(this,this.data),this.data.groups.measure.forEach((function(e,i){e.xScale=t.xScale,e.yScale=h.call(t,e),e.colorScale=g.call(t,e),e.containers=p.call(t,e,i),e.ids=d3.group(e,(function(t){return t.id})),e.aggregate=t.data.visits.reduce((function(i,n){return i.push([n,d3[t.settings.aggregate](e.filter((function(t){return t.visit===n})),(function(t){return t.result})),d3[t.settings.aggregate](e.filter((function(t){return t.visit===n})),(function(t){return t.change}))]),i}),[]),e.cuts=[d3.quantile(e.map((function(t){return t.result})).sort((function(t,e){return t-e})),.4),d3.quantile(e.map((function(t){return t.result})).sort((function(t,e){return t-e})),.6)],console.log(e.cuts),e.pct=t.data.visits.reduce((function(t,i){var n=e.filter((function(t){return t.visit===i}));return t.push([i,[n.filter((function(t){return e.cuts[1]<=t.result})).length/n.length,n.filter((function(t){return e.cuts[0]<=t.result&&t.result<e.cuts[1]})).length/n.length,n.filter((function(t){return t.result<e.cuts[0]})).length/n.length]]),t}),[]),b.call(t,e)})),this.interval=d3.interval((function(){R.call(t)}),this.settings.speed)}return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={data:e,element:n,settings:Object.assign(t,r),util:i};return s.containers=a.call(s),u.call(s),j.call(s),s}}));
