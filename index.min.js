!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=i()}(this,(function(){"use strict";var t={addElement:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,i){return i};return e?i.selectAll("".concat(n,".atm-").concat(t,".atm-").concat(n)).data(e,r).join(n).classed("atm-".concat(t," atm-").concat(n),!0):i.append(n).classed("atm-".concat(t," atm-").concat(n),!0)}};function i(t){return null===t.color_var&&(t.color_var=t.stratification_var),null===t.var_labels.stratification&&(t.var_labels.stratification=t.stratification_var),["ordinal","discrete"].includes(t.xType)||(t.xType="ordinal"),"ordinal"===t.xType?t.xVar="visit":"discrete"===t.xType&&(t.xVar="timepoint"),t.stratification_var!==t.color_var&&(t.annotate=!1,t.displayLegend=!0),t.footnotes=t.footnotes.map((function(i){return i.replace("[aggregate]",t.aggregate).replace("[outcome]",t.outcome)})),t}function n(){return{update:i,stratification_var:null,color_var:null,id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",var_labels:{stratification:null,color_var:null,id:"Participant ID",visit:"Visit",visit_order:"Visit Order",day:"Study Day",measure:"Measure",result:"Result"},aggregate:"mean",displayCIs:!0,alpha:.05,xType:"ordinal",xVar:"visit",offset:15,displayLegend:!1,annotate:!0,pointRadius:7.5,strokeWidth:5,fontSize:15,fontWeight:"bold",play:!0,timepoint:0,measureIndex:0,speed:1e3,pause:5e3,width:null,widthFactor:1,height:null,heightFactor:3,margin:{top:50,right:100,bottom:100,left:50},footnotes:[]}}function e(t){return this.util.addElement("charts",t)}function r(){var t=this.util.addElement("main",d3.select(this.element)),i=e.call(this,t),n=function(t,i){var n=t.node().clientWidth/i.widthFactor;return{width:n,height:n/i.heightFactor}}(i,this.settings),r=n.width,s=n.height;return this.settings.width=r,this.settings.height=s,this.settings.dimensions={width:r,height:s,margin:this.settings.margin,widthAdj:r-this.settings.margin.left-this.settings.margin.right,heightAdj:s-this.settings.margin.top-this.settings.margin.bottom},{main:t,charts:i}}function s(){var t=this;this.data.forEach((function(i){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(n){i[n.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(n)?parseFloat(i[t.settings[n]]):i[t.settings[n]]}))}))}function a(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,i){if(!t)return;if("string"==typeof t)return o(t,i);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o(t,i)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,i){(null==i||i>t.length)&&(i=t.length);for(var n=0,e=new Array(i);n<i;n++)e[n]=t[n];return e}function u(t,i){var n;switch(t){case"visit":n=a(new Set(i.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,i){return t.replace(/.*\|/,"")-i.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:n=a(new Set(i.map((function(i){return i[t]}))).values()).sort()}return n}function c(t,i){var n;switch(t){case"stratification,visit":n=d3.groups(i,(function(t){return t.stratification}),(function(t){return t.visit}));break;case"measure,id":n=d3.groups(i,(function(t){return t.measure}),(function(t){return t.id}));break;default:n=d3.group(i,(function(i){return i[t]}))}return n}function l(t,i){return{index:t,visit:i.visit[t],visit_order:i.visit_order[t]}}function f(){s.call(this),this.set=function(t){var i={};return i.stratification=u("stratification",t),i.color=u("color",t),i.id=u("id",t),i.visit=u("visit",t),i.visit_order=u("visit_order",t),i.day=u("day",t),i.measure=u("measure",t),i.timepoint=i.visit.map((function(i){return d3.median(t.filter((function(t){return t.visit===i})),(function(t){return t.day}))})),i}(this.data),this.set.offsets=d3.range(Math.ceil(-this.set.stratification.length/2)*this.settings.offset+this.settings.offset/2*!(this.set.stratification.length%2),Math.ceil(this.set.stratification.length/2)*this.settings.offset+this.settings.offset/2*!(this.set.stratification.length%2),this.settings.offset),this.group=function(t){var i={};return i.stratification=c("stratification",t),i.stratification_visit=c("stratification,visit",t),i.color=c("color",t),i.id=c("id",t),i.visit=c("visit",t),i.measure=c("measure",t),i.measure_id=c("measure,id",t),i}(this.data),this.summary=function(t,i,n){var e=d3.rollups(t,(function(t){var i=t.map((function(t){return t.result})).sort((function(t,i){return t-i})),e=(jStat(i),t.length),r=d3.mean(i),s=d3.deviation(i),a=jStat.tci(r,n.alpha,i),o=d3.min(i),u=d3.median(i),c=d3.max(i),l=jStat.geomean(i),f={n:e,mean:r,deviation:s,mean_ci:a,min:o,median:u,max:c,geomean:l,geomean_ci:jStat.tci(Math.log(l),n.alpha,i.map((function(t){return Math.log(t)}))).map((function(t){return Math.exp(t)}))};return{data:t,stats:f,value:f[n.aggregate]}}),(function(t){return t.measure}),(function(t){return t.stratification}),(function(t){return t.visit}));return e.forEach((function(t,e){var r=Array(i.stratification.length*i.visit.length);i.stratification.forEach((function(e,s){var o=t[1].find((function(t){return t[0]===e}));void 0===o&&(o=[e,i.visit.map((function(t){return[t,{data:[],value:null}]}))],t[1].splice(s,0,o)),o&&o[1].sort((function(t,n){return i.visit.indexOf(t[0])-i.visit.indexOf(n[0])})),o.color_value=o[1][0][1].data[0][n.color_var],o.offset=i.offsets[s],i.visit.forEach((function(n,e){var u=o[1].find((function(t){return t[0]===n}));void 0===u&&(u=a(o[1][e-1]),o[1].splice(e,0,u)),u.visit=u[0],u.index=i.visit.findIndex((function(t){return t===u[0]})),u.visit_order=i.visit_order[u.index],u.timepoint=i.timepoint[u.index],u.stratum=o;var c={measure:t[0],stratum:o[0],visit:u[0],value:u[0]===n?u[1].value:null};r[s*i.visit.length+e]=c}))})),t.tabular=r.filter((function(t){return!0})),t.visits=a(new Set(t.tabular.map((function(t){return t.visit}))).values())})),e}(this.data,this.set,this.settings),this.timepoint=l(this.settings.timepoint,this.set),this.measureIndex=0,this.measure=this.summary[this.measureIndex]}function d(t,i){var n=this.layout.charts.insert("div",":first-child").classed("atm-container atm-div",!0),e=this.util.addElement("header",n,"h3").text(t),r=this.util.addElement("time-series__svg",n,"svg").attr("width",i.width).attr("height",i.height);return{main:n,header:e,canvas:r,svg:this.util.addElement("time-series__g",r,"g").attr("transform","translate("+i.margin.left+","+i.margin.top+")")}}function g(t,i){return d3.scaleLinear().domain([d3.min(t),d3.max(t)]).nice().range([i.heightAdj,0])}function h(t,i,n){var e=t.append("g").classed("atm-legend",!0);return e.selectAll("mydots").data(i.domain()).join("circle").attr("cx",n.width-n.margin.left-n.margin.right+10).attr("cy",(function(t,i){return 20*i-n.margin.top/2})).attr("r",4).style("fill",(function(t){return i(t)})),e.selectAll("mylabels").data(i.domain()).join("text").attr("x",n.width-n.margin.left-n.margin.right+15).attr("y",(function(t,i){return 20*i-n.margin.top/2})).style("fill",(function(t){return i(t)})).text((function(t){return t})).attr("text-anchor","left").style("font-size",this.settings.fontSize).style("font-weight",this.settings.fontWeight).style("alignment-baseline","middle"),e}function m(t,i,n){var e=this,r=d3.line().x((function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).y((function(t){return n.y(t[1].value)})),s=t.selectAll("path.line").data(i).join("path").classed("line",!0);return s.attr("d",(function(t){var i=t[1][e.settings.timepoint],n=t[1].map((function(t,n){return n>=e.settings.timepoint?i:t}));return r(n)})).attr("stroke",(function(t){return n.color(t.color_value)})).attr("stroke-width",this.settings.strokeWidth).attr("stroke-opacity",.75).attr("fill","none"),s.lineGenerator=r,s}function v(t,i,n){var e=this,r=t.selectAll("g.point-group").data(i,(function(t){return t[0]})).join("g").classed("point-group",!0);return r.attr("fill",(function(t){return n.color(t.color_value)})),r.selectAll("circle.point").data((function(t){return t[1].slice(0,e.settings.timepoint+1)}),(function(t,i){return[t.stratum[0],i].join("|")})).join("circle").classed("point",!0).attr("cx",(function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).attr("cy",(function(t){return n.y(t[1].value)})).attr("r",this.settings.pointRadius).attr("stroke","white"),r}function p(t,i,n){var e=this,r=t.selectAll("g.ci-group").data(i,(function(t){return t[0]})).join("g").classed("ci-group",!0);return r.attr("stroke",(function(t){return n.color(t.color_value)})).attr("stroke-width",this.settings.strokeWidth),r.selectAll("line.ci").data((function(t){return t[1].slice(0,e.settings.timepoint+1)}),(function(t,i){return[t.stratum[0],i].join("|")})).join("line").classed("ci",!0).attr("x1",(function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).attr("x2",(function(t){return n.x(t[e.settings.xVar])+t.stratum.offset})).attr("y1",(function(t){return n.y(t[1].stats["".concat(e.settings.aggregate,"_ci")][0])})).attr("y2",(function(t){return n.y(t[1].stats["".concat(e.settings.aggregate,"_ci")][1])})).attr("stroke-linecap","round"),r}function y(t){var i=this.settings.fontSize;t.sort((function(t,i){return i.y-t.y})).forEach((function(n,e){if(e>0){var r=t[e-1].y-n.y;r<i&&(n.y=n.y-(i-r))}}))}function x(t,i,n){var e=this,r=t.selectAll("text.annotation").data(i).join("text").classed("annotation",!0);return r.datum((function(t){var i=t[1][e.settings.timepoint];return{x:n.x(i[e.settings.xVar]),y:n.y(i[1].value),color:n.color(t[0]),text:t[0],stratum:t}})),y.call(this,r.data()),r.attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y})).attr("dx",2*this.settings.offset).attr("dy",this.settings.fontSize/3).attr("fill",(function(t){return t.color})).style("font-size",this.settings.fontSize).style("font-weight",this.settings.fontWeight).text((function(t){return t.text})),r}function _(t){var i=this,n=this.settings.dimensions,e=function(t,i,n){var e;if("ordinal"===t)e=d3.scalePoint().domain(i).range([0,n.widthAdj]).padding([.5]);else{var r=d3.extent(i),s=r[1]-r[0];e=d3.scaleLinear().domain([r[0]-.05*s,r[1]+.05*s]).range([0,n.widthAdj])}return e}(this.settings.xType,this.set[this.settings.xVar],n),r=function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d3.schemeSet2,n=d3.scaleOrdinal().domain(t).range(i);return n}(this.set.color),s=t[1],a=d.call(this,t[0],n),o=t.tabular.map((function(t){return t.value}));this.settings.displayCIs&&s.map((function(t){return t[1]})).flat().map((function(t){return t[1].stats["".concat(i.settings.aggregate,"_ci")]})).flat().forEach((function(t){return o.push(t)})),t.scales={x:e.copy(),y:g(o,n),color:r.copy()},t.xAxis=function(t,i,n,e,r){var s=t.append("g").classed("atm-axis",!0).attr("transform","translate(0,"+n.heightAdj+")");return"ordinal"===e?s.call(d3.axisBottom(i)):s.call(d3.axisBottom(i).tickValues(r.timepoint).tickFormat((function(t,i){return r.visit[i]}))),s.selectAll("text").style("text-anchor","end").attr("transform","rotate(-45)").attr("dx","-.8em").attr("dy",".15em"),s}(a.svg,t.scales.x,n,this.settings.xType,this.set,t.visits),t.yAxis=function(t,i,n){var e=t.append("g").classed("atm-axis",!0).call(d3.axisLeft(i));return e.grid=t.append("g").call((function(t){return t.attr("class","grid-lines").selectAll("line").data(i.ticks()).join("line").attr("x1",0).attr("x2",n.widthAdj).attr("y1",(function(t){return i(t)})).attr("y2",(function(t){return i(t)}))})),e}(a.svg,t.scales.y,n),t.lines=m.call(this,a.svg,s,t.scales),t.points=v.call(this,a.svg,s,t.scales),this.settings.displayCIs&&(t.CIs=p.call(this,a.svg,s,t.scales)),this.settings.annotate?t.annotations=x.call(this,a.svg,s,t.scales):t.legend=h.call(this,a.svg,t.scales.color,n)}function A(t,i){var n=this;t.transition().duration(this.settings.speed-.25*this.settings.speed*this.settings.displayCIs).attr("d",(function(i){var e=i[1][n.settings.timepoint],r=i[1].map((function(t,i){return i>=n.settings.timepoint?e:t}));return t.lineGenerator(r)}))}function j(t,i){var n=this;return t.selectAll("circle.point").data((function(t){return t[1].slice(0,n.settings.timepoint+1)}),(function(t,i){return[t.stratum[0],i].join("|")})).join((function(t){return t.append("circle").classed("point",!0).attr("r",n.settings.pointRadius).attr("stroke","white").attr("cx",(function(t){var e=t.stratum[1][n.settings.timepoint-1];return i.x(e[n.settings.xVar])+e.stratum.offset})).attr("cy",(function(t){var e=t.stratum[1][n.settings.timepoint-1];return i.y(e[1].value)})).call((function(t){return t.transition().duration(n.settings.speed-.25*n.settings.speed*n.settings.displayCIs).attr("cx",(function(t){return i.x(t[n.settings.xVar])+t.stratum.offset})).attr("cy",(function(t){return i.y(t[1].value)}))}))})),t}function b(t,i){var n=this;return t.selectAll("line.ci").data((function(t){return t[1].slice(0,n.settings.timepoint+1)}),(function(t,i){return[t.stratum[0],i].join("|")})).join((function(t){return t.append("line").classed("ci",!0).attr("x1",(function(t){return i.x(t[n.settings.xVar])+t.stratum.offset})).attr("x2",(function(t){return i.x(t[n.settings.xVar])+t.stratum.offset})).attr("y1",(function(t){return i.y(t[1].value)})).attr("y2",(function(t){return i.y(t[1].value)})).call((function(t){return t.transition().duration(.25*n.settings.speed).delay(.75*n.settings.speed).attr("y1",(function(t){return i.y(t[1].stats["".concat(n.settings.aggregate,"_ci")][0])})).attr("y2",(function(t){return i.y(t[1].stats["".concat(n.settings.aggregate,"_ci")][1])})).attr("stroke-linecap","round")}))})),t}function w(t,i){var n=this;t.datum((function(t){var e=t.stratum[1][n.settings.timepoint];return{x:i.x(e[n.settings.xVar]),y:i.y(e[1].value),color:i.color(t[0]),text:t[0],stratum:t.stratum}})),y.call(this,t.data()),t.transition().duration(this.settings.speed-.25*this.settings.speed*this.settings.displayCIs).attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y}))}function I(t){var i=this;this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length?(this.interval.stop(),d3.timeout((function(){i.settings.timepoint=0,i.measureIndex++,i.measureIndex<i.summary.length&&(i.measure=i.summary[i.measureIndex],_.call(i,i.measure),i.interval=d3.interval((function(){I.call(i,i.measure)}),i.settings.speed))}),this.settings.pause)):(this.timepoint=l(this.settings.timepoint,this.set),A.call(this,t.lines,t.scales),j.call(this,t.points,t.scales),this.settings.displayCIs&&b.call(this,t.CIs,t.scales),this.settings.annotate&&w.call(this,t.annotations,t.scales))}function S(){var t=this;_.call(this,this.measure),this.interval=d3.interval((function(){I.call(t,t.measure)}),this.settings.speed)}return function(i){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a={data:i,element:e,settings:n().update(Object.assign(n(),s)),util:t};return a.layout=r.call(a),f.call(a),S.call(a),a}}));
