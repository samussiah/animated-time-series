!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=n()}(this,(function(){"use strict";function t(t,n,i){return t.find((function(t){return t[n]===i}))}d3.geomean=function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(t){return t},i=64,r=Math.pow(2,i),e=Math.pow(2,-i),a=1,o=0,s=1,u=0,l=0;l<t.length;l++){var c=n(t[l]);if(+c==+c){if(o++,0===(s=Math.sign(c)))return 0;for(a*=Math.abs(c);a>r;)a*=e,++u;for(;a<e;)a*=r,--u}}return o?s*Math.pow(2,(Math.log2(a)+u*i)/o):NaN};var n={addElement:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,e=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,n){return n};return r?n.selectAll("".concat(i,".atm-").concat(t,".atm-").concat(i)).data(r,e).join(i).classed("atm-".concat(t," atm-").concat(i),!0):n.append(i).classed("atm-".concat(t," atm-").concat(i),!0)},getDatum:t,getValue:function(n,i,r,e){var a=t(n,i,r);return a?a[e]:null}};function i(t){return null===t.color_var&&(t.color_var=t.stratification_var),null===t.var_labels.stratification&&(t.var_labels.stratification=t.stratification_var),t.footnotes=t.footnotes.map((function(n){return n.replace("[aggregate]",t.aggregate).replace("[outcome]",t.outcome)})),t}function r(){return{update:i,stratification_var:null,color_var:null,id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",var_labels:{stratification:null,color_var:null,id:"Participant ID",visit:"Visit",visit_order:"Visit Order",measure:"Measure",result:"Result"},aggregate:"mean",play:!0,timepoint:0,speed:1e3,loop_delay:1e4,width:null,height:null,margin:{},annotate:!0,fontSize:15,fontWeight:"bold",footnotes:[]}}function e(t){var n=this.layout?this.layout.charts:t;this.settings.width=n.node().clientWidth/1,this.settings.height=this.settings.width/3,this.settings.margin={top:30,right:30,bottom:40,left:40}}function a(t){return function(t){if(Array.isArray(t))return s(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||o(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,n){if(t){if("string"==typeof t)return s(t,n);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?s(t,n):void 0}}function s(t,n){(null==n||n>t.length)&&(n=t.length);for(var i=0,r=new Array(n);i<n;i++)r[i]=t[i];return r}function u(t,n){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=o(t))||n&&t&&"number"==typeof t.length){i&&(t=i);var r=0,e=function(){};return{s:e,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,u=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return s=t.done,t},e:function(t){u=!0,a=t},f:function(){try{s||null==i.return||i.return()}finally{if(u)throw a}}}}function l(t){return this.util.addElement("charts",t)}function c(){e.call(this)}function f(){var t=this.util.addElement("main",d3.select(this.element)),n=l.call(this,t);return e.call(this,n),window.addEventListener("resize",c.bind(this)),{main:t,charts:n}}function d(){var t=this;this.data.forEach((function(n){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(i){n[i.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(i)?parseFloat(n[t.settings[i]]):n[t.settings[i]]}))}))}function h(t,n){var i;switch(t){case"visit":i=a(new Set(n.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,n){return t.replace(/.*\|/,"")-n.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:i=a(new Set(n.map((function(n){return n[t]}))).values()).sort()}return i}function v(t,n){var i;switch(t){case"stratification,visit":i=d3.groups(n,(function(t){return t.stratification}),(function(t){return t.visit}));break;case"measure,id":i=d3.groups(n,(function(t){return t.measure}),(function(t){return t.id}));break;default:i=d3.group(n,(function(n){return n[t]}))}return i}function m(t,n){return{index:t,visit:n.visit[t],visit_order:n.visit_order[t]}}function g(){d.call(this),this.set=function(t){var n={};return n.stratification=h("stratification",t),n.color=h("color",t),n.id=h("id",t),n.visit=h("visit",t),n.visit_order=h("visit_order",t),n.day=h("day",t),n.measure=h("measure",t),n.timepoint=n.visit.map((function(n){return d3.median(t.filter((function(t){return t.visit===n})),(function(t){return t.day}))})),console.table(n.timepoint),n}(this.data),this.group=function(t){var n={};return n.stratification=v("stratification",t),n.stratification_visit=v("stratification,visit",t),n.color=v("color",t),n.id=v("id",t),n.visit=v("visit",t),n.measure=v("measure",t),n.measure_id=v("measure,id",t),n}(this.data),this.summary=function(t,n,i){var r=d3.rollups(t,(function(t){return{data:t,value:d3[i.aggregate](t,(function(t){return t.result}))}}),(function(t){return t.measure}),(function(t){return t.stratification}),(function(t){return t.visit}));return r.forEach((function(t,r){var e=Array(n.stratification.length*n.visit.length);n.stratification.forEach((function(r,o){var s=t[1].find((function(t){return t[0]===r}));s&&s[1].sort((function(t,i){return n.visit.indexOf(t[0])-n.visit.indexOf(i[0])})),s.color_value=s[1][0][1].data[0][i.color_var],n.visit.forEach((function(i,r){var u=s[1].find((function(t){return t[0]===i}));void 0===u&&(u=a(s[1][r-1]),s[1].splice(r,0,u)),u.stratum=s;var l={measure:t[0],stratum:s[0],visit:u[0],value:u[0]===i?u[1].value:null};e[o*n.visit.length+r]=l}))})),t.tabular=e.filter((function(t){return!0})),t.visits=a(new Set(t.tabular.map((function(t){return t.visit}))).values())})),r}(this.data,this.set,this.settings),this.timepoint=m(this.settings.timepoint,this.set)}function p(t,n){var i=this.util.addElement("container",this.layout.charts),r=this.util.addElement("header",i,"h3").text(t),e=n.width+n.margin.left+n.margin.right,a=n.height+n.margin.top+n.margin.bottom,o=n.margin,s=this.util.addElement("time-series__svg",i,"svg").attr("width",e).attr("height",a).append("g").attr("transform","translate("+o.left+","+o.top+")");return s.dimensions=n,s.width=e,s.height=a,s.margin=o,{main:i,header:r,svg:s}}function y(t,n,i,r){var e=d3.scalePoint().domain(t).range([0,n.width]).padding([.5]);return i.append("g").classed("atm-axis",!0).attr("transform","translate(0,"+n.height+")").call(d3.axisBottom(e)).selectAll(".tick").classed("atm-missing",(function(t){return!1===r.includes(t)})),e}function b(t,n,i){var r=d3.scaleLinear().domain(t).nice().range([n.height,0]);i.append("g").classed("atm-axis",!0).call(d3.axisLeft(r));return i.append("g").call((function(t){return t.attr("class","grid-lines").selectAll("line").data(r.ticks()).join("line").attr("x1",0).attr("x2",n.width).attr("y1",(function(t){return r(t)})).attr("y2",(function(t){return r(t)}))})),r}function _(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d3.schemeSet2,i=d3.scaleOrdinal().domain(t).range(n);return i}function x(t,n,i){var r=this,e=d3.line().x((function(t){return i.x(t[0])})).y((function(t){return i.y(t[1].value)})),a=t.selectAll("path.line").data(n).join("path").classed("line",!0);return a.attr("d",(function(t){var n=t[1][r.settings.timepoint],i=t[1].map((function(t,i){return i>=r.settings.timepoint?n:t}));return e(i)})).attr("stroke",(function(t){return i.color(t.color_value)})).attr("stroke-width",Math.max(12/this.set.stratification.length,1)).attr("fill","none"),a.lineGenerator=e,a}function w(t,n,i){var r=this,e=t.selectAll("g.point-group").data(n,(function(t){return t[0]})).join("g").classed("point-group",!0);return e.attr("fill",(function(t){return i.color(t.color_value)})),e.selectAll("circle.point").data((function(t){return t[1].slice(0,r.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join("circle").classed("point",!0).attr("cx",(function(t){return i.x(t[0])})).attr("cy",(function(t){return i.y(t[1].value)})).attr("r",5).attr("stroke","white"),e}function A(t){var n=this.settings.fontSize;t.sort((function(t,n){return n.y-t.y})).forEach((function(i,r){if(r>0){var e=t[r-1].y-i.y;e<n&&(i.y=i.y-(n-e))}}))}function S(t,n,i){var r=this,e=t.selectAll("text.annotation").data(n).join("text").classed("annotation",!0);return e.datum((function(t){var n=t[1][r.settings.timepoint];return{x:i.x(n[0]),y:i.y(n[1].value),color:i.color(t[0]),text:t[0],stratum:t}})),A.call(this,e.data()),e.attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y})).attr("dx",7).attr("dy",this.settings.fontSize/3).attr("fill",(function(t){return t.color})).style("font-size",this.settings.fontSize).style("font-weight",this.settings.fontWeight).text((function(t){return t.text})),e}function j(t,n){var i=this;t.transition().duration(this.settings.speed).attr("d",(function(n){var r=n[1][i.settings.timepoint],e=n[1].map((function(t,n){return n>=i.settings.timepoint?r:t}));return t.lineGenerator(e)}))}function E(t,n){var i=this;return t.selectAll("circle.point").data((function(t){return t[1].slice(0,i.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join((function(t){return t.append("circle").classed("point",!0).attr("r",5).attr("stroke","white").attr("cx",(function(t){var r=t.stratum[1][i.settings.timepoint-1];return n.x(r[0])})).attr("cy",(function(t){var r=t.stratum[1][i.settings.timepoint-1];return n.y(r[1].value)})).call((function(t){return t.transition().duration(i.settings.speed).attr("cx",(function(t){return n.x(t[0])})).attr("cy",(function(t){return n.y(t[1].value)}))}))})),t}function I(t,n){var i=this;t.datum((function(t){var r=t.stratum[1][i.settings.timepoint];return{x:n.x(r[0]),y:n.y(r[1].value),color:n.color(t[0]),text:t[0],stratum:t.stratum}})),A.call(this,t.data()),t.transition().duration(this.settings.speed).attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y}))}function k(){var t,n=this,i=function(t){var n={top:2*t.fontSize,right:100,bottom:25,left:50};return{margin:n,width:500-n.left-n.right,height:200-n.top-n.bottom}}(this.settings),r=u(this.summary);try{for(r.s();!(t=r.n()).done;){var e=t.value,a=e[1],o=p.call(this,e[0],i),s={x:y(this.set.visit,i,o.svg,e.visits),y:b([d3.min(e.tabular,(function(t){return t.value})),d3.max(e.tabular,(function(t){return t.value}))],i,o.svg),color:_(this.set.color)};e.scales=s,e.lines=x.call(this,o.svg,a,s),e.points=w.call(this,o.svg,a,s),this.settings.annotate&&(e.annotations=S.call(this,o.svg,a,s))}}catch(t){r.e(t)}finally{r.f()}var l=function(){if(this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length)this.interval.stop(),this.settings.timepoint=0;else{this.timepoint=m(this.settings.timepoint,this.set);var t,n=u(this.summary);try{for(n.s();!(t=n.n()).done;){var i=t.value;j.call(this,i.lines,i.scales),E.call(this,i.points,i.scales),this.settings.annotate&&I.call(this,i.annotations,i.scales)}}catch(t){n.e(t)}finally{n.f()}}};this.interval=d3.interval((function(){l.call(n)}),this.settings.speed)}return function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a={data:t,element:i,settings:r().update(Object.assign(r(),e)),util:n};return a.layout=f.call(a),g.call(a),k.call(a),a}}));
