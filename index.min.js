!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=e()}(this,(function(){"use strict";var t={id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",baseline_var:"BASE",change_var:"CHG",percent_change_var:"PCHG",aggregate:"mean",speed:2500,loop_time:5e3,paused:!1,x_var:"day",x_type:"linear",y_var:"result",y_type:"linear",y_limits:null,color_var:"change",color_type:"linear"};function e(t,e,i){return t.find((function(t){return t[e]===i}))}var i={getDatum:e,getValue:function(t,i,n,a){var s=e(t,i,n);return s?s[a]:null}};function n(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",n=e.append(i).classed("atm-".concat(t),!0).classed("atm-".concat(i),!0).classed("atm-".concat(t,"__").concat(i),!0);return n}function a(t){var e=this.containers?this.containers.main:t;this.settings.width=e.node().clientWidth/2,this.settings.height=this.settings.width/3,this.settings.margin={top:30,right:30,bottom:40,left:40}}function s(t){var e=this;t.lines.each((function(i){var n=i[1].find((function(t){return t.visit===e.visit})),a=i[1].findIndex((function(t){return t.visit===e.visit})),s=i[1].slice(0,a).pop(),r=d3.select(this);s&&n?r.attr("x1",t.xScale(s[e.settings.x_var])+("ordinal"===e.settings.x_type?t.xScale.bandwidth()/2:0)).attr("y1",t.yScale(s[e.settings.y_var])).attr("x2",t.xScale(s[e.settings.x_var])+("ordinal"===e.settings.x_type?t.xScale.bandwidth()/2:0)).attr("y2",t.yScale(s[e.settings.y_var])).attr("stroke","percent_change"===e.settings.color_var?t.colorScale((n[e.settings.y_var]-s[e.settings.y_var])/s[e.settings.y_var]*100):t.colorScale(n[e.settings.y_var]-s[e.settings.y_var])).attr("stroke-opacity",.25).transition().ease(d3.easeQuad).duration(2*e.settings.speed/5).attr("x2",t.xScale(n[e.settings.x_var])+("ordinal"===e.settings.x_type?t.xScale.bandwidth()/2:0)).attr("y2",t.yScale(n[e.settings.y_var])):r.transition().duration(2*e.settings.speed/5).attr("stroke-opacity",0)}))}function r(t){var e=this;t.points.each((function(i){var n=i[1].find((function(t){return t.visit===e.visit})),a=(i[1].find((function(t){return!!t.result})),d3.select(this));0!==e.visit||n?"none"===a.style("display")&&n&&a.attr("cx",t.xScale(n.day)).attr("cy",t.yScale(n.result)):a.style("display","none");var s=a.transition().ease(d3.easeQuad).duration(2*e.settings.speed/5).delay(1*e.settings.speed/5).attr("fill-opacity",.25).attr("stroke-opacity",.5);n&&s.attr("cx",t.xScale(n[e.settings.x_var])+("ordinal"===e.settings.x_type?t.xScale.bandwidth()/2:0)).attr("cy",t.yScale(n[e.settings.y_var])).attr("fill",t.colorScale(n[e.settings.color_var])).attr("stroke",t.colorScale(n[e.settings.color_var]))}))}function o(t){var e=this;if(t.linesAggregate.filter((function(t,i){return i===e.visitIndex-1})).transition().duration(2*this.settings.speed/5).delay(1*this.settings.speed/5).attr("x2",(function(i,n){return"ordinal"===e.settings.x_type?t.xScale(e.visit)+t.xScale.bandwidth()/2:t.xScale(e.timepoint)})).attr("y2",(function(e){return t.yScale(e[1][1])})),0===this.visitIndex){var i=this.settings.speed/this.data.visits.length;t.linesAggregate.transition().duration(i).delay((function(t,n){return e.settings.speed-i*n})).attr("x2",(function(){return this.getAttribute("x1")})).attr("y2",(function(){return this.getAttribute("y1")}))}}function l(t){var e=this;if(this.visitIndex>0?t.pointsAggregate.transition().ease(d3.easeQuad).duration(2*this.settings.speed/5).delay(2*this.settings.speed/5).attr("cx","ordinal"===this.settings.x_type?t.xScale(this.visit)+t.xScale.bandwidth()/2:t.xScale(this.timepoint)).attr("cy",(function(i){return t.yScale(i[e.visitIndex][1])})).attr("fill",(function(i,n){return t.colorScale(i[e.visitIndex]["change"===e.settings.color_var?2:3])})):t.pointsAggregate.attr("cx","ordinal"===this.settings.x_type?t.xScale(this.visit)+t.xScale.bandwidth()/2:t.xScale(this.timepoint)).attr("cy",(function(e){return t.yScale(e[0][1])})).attr("fill",t.colorScale(0)),t.pointsAggregate.clone().classed("atm-clone",!0),0===this.visitIndex){var i=this.settings.speed/this.data.visits.length;t.containers.timeSeries.canvas.selectAll(".atm-clone").transition().duration(i).delay((function(t,e){return i*e})).attr("fill-opacity",0).attr("stroke-opacity",0).remove()}}function c(){var t=this,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.visitIndex=!0===e?this.visitIndex>=this.data.visits.length-1?0:this.visitIndex+1:Math.max(this.visitIndex-1,0),this.visitIndex===this.data.visits.length-1&&(this.interval.stop(),d3.timeout((function(e){t.interval=d3.interval((function(){c.call(t)}),t.settings.speed)}),this.settings.loop_time)),0===this.visitIndex&&(this.interval.stop(),d3.timeout((function(e){t.interval=d3.interval((function(){c.call(t)}),t.settings.speed)}),1e3)),this.visit=this.data.visits[this.visitIndex],this.timepoint=this.data.timepoints[this.visitIndex],this.containers.timepoint.transition().delay(this.settings.speed/2).text(this.visit),this.data.groups.measure.forEach((function(e,i){s.call(t,e),r.call(t,e),o.call(t,e),l.call(t,e)})),!0===i&&this.interval.stop()}function d(t){var e=this;n("button__play-pause",t,"button").classed("atm-paused",!this.settings.paused).attr("title",this.settings.paused?"Play animation.":"Pause animation.").on("click",(function(){return this.classList.toggle("atm-paused"),e.settings.paused=!e.settings.paused,e.settings.paused?(e.interval.stop(),this.title="Play animation."):(e.interval=d3.interval((function(){c.call(e)}),e.settings.speed),this.title="Pause animation."),!1}))}function u(t){var e=this,i=n("button__step",t,"button").classed("atm-step--backward",!0),a=(n("step-label",t,"span").text("Step"),n("button__step",t,"button").classed("atm-step--forward",!0));i.on("click",(function(){return e.settings.paused=!0,c.call(e,!1,!0),e.controls.this.classList.toggle("atm-paused"),e.settings.paused=!e.settings.paused,this.title="Play animation.",!1})),a.on("click",(function(){return e.settings.paused=!0,c.call(e,!0,!0),!1}))}function g(t){var e=n("play-pause-toggle",t);d.call(this,e);var i=n("step",t);u.call(this,i)}function h(t){t.containers.timeSeries.xAxis.selectAll("*").remove(),t.containers.timeSeries.yAxis.selectAll("*").remove(),t.containers.timeSeries.lines.selectAll("*").remove(),t.containers.timeSeries.points.selectAll("*").remove(),t.containers.timeSeries.pointsAggregate.selectAll("*").remove(),t.containers.timeSeries.linesAggregate.selectAll("*").remove()}function p(t){var e=this;return t.containers.timeSeries.xAxis.attr("transform","translate(0,".concat(this.settings.height-this.settings.margin.bottom,")")).call(d3.axisBottom(t.xScale).ticks(this.settings.width/80)).call((function(t){return t.append("text").attr("x",(e.settings.width-e.settings.margin.left)/2).attr("y",e.settings.margin.bottom/2+4).attr("fill","currentColor").attr("text-anchor","center").attr("alignment-baseline","hanging").text("Study Day")}))}function f(t){var e=this;return t.containers.timeSeries.yAxis.attr("transform","translate(".concat(this.settings.margin.left,",0)")).call(d3.axisLeft(t.yScale)).call((function(t){return t.select(".domain").remove()})).call((function(i){return i.append("g").attr("stroke","currentColor").attr("stroke-opacity",.1).selectAll("line").data(t.yScale.ticks()).join("line").attr("y1",(function(e){return.5+t.yScale(e)})).attr("y2",(function(e){return.5+t.yScale(e)})).attr("x1",0).attr("x2",e.settings.width-e.settings.margin.right-e.settings.margin.left)}))}function v(t){return t.containers.timeSeries.lines.selectAll("line").data(t.ids,(function(t){return t[0]})).join("line").attr("stroke-opacity",0)}function m(t){var e=this;return t.containers.timeSeries.points.selectAll("circle").data(t.ids,(function(t){return t[0]})).join("circle").attr("cx",(function(i){return t.xScale(e.util.getValue(i[1],"visit",e.visit,e.settings.x_var))+("ordinal"===e.settings.x_type?t.xScale.bandwidth()/2:0)})).attr("cy",(function(i){return t.yScale(e.util.getValue(i[1],"visit",e.visit,e.settings.y_var))})).attr("r",1).attr("fill",t.colorScale(0)).attr("fill-opacity",.25).attr("stroke",t.colorScale(0)).attr("stroke-opacity",.5)}function y(t){var e=this;return t.containers.timeSeries.linesAggregate.datum(t.aggregate).selectAll("line.atm-line-aggregate").data(d3.pairs(t.aggregate)).join("line").classed("atm-line-aggregate",!0).attr("x1",(function(i,n){return"ordinal"===e.settings.x_type?t.xScale(e.data.visits[n])+t.xScale.bandwidth()/2:t.xScale(e.data.timepoints[n])})).attr("x2",(function(i,n){return"ordinal"===e.settings.x_type?t.xScale(e.data.visits[n])+t.xScale.bandwidth()/2:t.xScale(e.data.timepoints[n])})).attr("y1",(function(e){return t.yScale(e[0][1])})).attr("y2",(function(e){return t.yScale(e[0][1])})).attr("stroke",(function(i){var n=i[1][1]-i[0][1];return"percent_change"===e.settings.color_var?t.colorScale(n/i[0][1]*100):t.colorScale(n)})).attr("stroke-width",3)}function x(t){return t.containers.timeSeries.pointsAggregate.append("circle").datum(t.aggregate).classed("atm-point-aggregate",!0).attr("cx","ordinal"===this.settings.x_type?t.xScale(this.visit)+t.xScale.bandwidth()/2:t.xScale(this.timepoint)).attr("cy",(function(e){return t.yScale(e[0][1])})).attr("r",4).attr("fill",t.colorScale(0)).attr("fill-opacity",1).attr("stroke","black").attr("stroke-opacity",1)}function S(t){h.call(this,t),t.xAxis=p.call(this,t),t.yAxis=f.call(this,t),t.lines=v.call(this,t),t.points=m.call(this,t),t.linesAggregate=y.call(this,t),t.pointsAggregate=x.call(this,t)}function _(){var t=this;a.call(this),this.data.groups.measure.forEach((function(e){e.containers.timeSeries.svg.attr("width",t.settings.width).attr("height",t.settings.height),e.xScale.rangeRound([t.settings.margin.left,t.settings.width-t.settings.margin.right]),e.yScale.rangeRound([t.settings.height-t.settings.margin.bottom,t.settings.margin.top]),S.call(t,e)}))}function b(){var t=n("main",d3.select(this.element));a.call(this,t);var e=n("controls",t),i=n("timepoint",e,"span");g.call(this,e);var s=n("charts",t),r=n("footnote",t,"small"),o=["<sup>1</sup> The color of points represents ".concat(this.settings.color_var.replace("_"," ")," from baseline."),"<sup>2</sup> The color of lines represents ".concat(this.settings.color_var.replace("_"," ")," from the previous timepoint.")];return null!==this.settings.y_limits&&o.push("<sup>*</sup> To mitigate the effect of outliers, the range of the y-axis encompasses the ".concat(this.settings.y_limits.map((function(t){return"".concat(t,"th")})).join(" through ")," quantile of the results.")),r.html(o.join("<br>")),window.addEventListener("resize",_.bind(this)),{main:t,controls:e,timepoint:i,charts:s}}function w(t){return function(t){if(Array.isArray(t))return A(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return A(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);"Object"===i&&t.constructor&&(i=t.constructor.name);if("Map"===i||"Set"===i)return Array.from(t);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return A(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function A(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function k(){var t=this;this.data.every((function(t){return/^-?\d+\.?\d*$/.test(t.id)||/^-?\d*\.?\d+$/.test(t.id)}));this.data.forEach((function(e){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(i){e[i.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(i)?parseFloat(e[t.settings[i]]):e[t.settings[i]]}))}))}function I(){return{id:new Set(this.data.map((function(t){return t.id}))),visit:new Set(this.data.map((function(t){return t.visit}))),visit_order:new Set(this.data.map((function(t){return t.visit_order}))),day:new Set(this.data.map((function(t){return t.day}))),measure:new Set(this.data.map((function(t){return t.measure})))}}function j(){return{id:d3.group(this.data,(function(t){return t.id})),visit:d3.group(this.data,(function(t){return t.visit})),measure:d3.group(this.data.sort((function(t,e){return t.measure<e.measure?-1:e.measure<t.measure?1:0})),(function(t){return t.measure}))}}function R(){var t=this;k.call(this),this.data.sets=I.call(this),this.data.visits=w(new Set(this.data.map((function(t){return"".concat(t.visit_order,"|").concat(t.visit)}))).values()).map((function(t){return t.split("|")})).sort((function(t,e){return t[0]-e[0]})).map((function(t){return t[1]})),this.data.timepoints=this.data.visits.map((function(e){return d3.median(t.data.filter((function(t){return t.visit===e})),(function(t){return t.day}))})),this.data.groups=j.call(this)}function C(t){var e;switch(this.settings.x_type){case"linear":e=d3.scaleLinear().domain(d3.extent(t,(function(t){return t.day})));break;case"ordinal":e=d3.scaleBand().domain(t.visits);break;case"log":d3.scaleLog().domain(d3.extent(t,(function(t){return t.day})));break;default:alert("[ ".concat(this.settings.x_type," ] is an invalid x-axis type.  Please choose one of [ 'linear', 'ordinal', 'log' ]."))}return e.rangeRound([this.settings.margin.left,this.settings.width-this.settings.margin.right]),e}function L(t){var e=this,i=null===this.settings.y_limits?[0,100]:this.settings.y_limits,n=t.map((function(t){return t[e.settings.y_var]})).sort((function(t,e){return t-e})),a=i.map((function(t){return d3.quantile(n,t/100)}));return d3.scaleLinear().domain(a).rangeRound([this.settings.height-this.settings.margin.bottom,this.settings.margin.top])}function P(t){var e=this,i="change"===this.settings.color_var?d3.max(t,(function(t){return Math.abs(t[e.settings.color_var])})):100;return d3.scaleSequential().domain([-i,i]).interpolator(d3.interpolateViridis).clamp(!0)}function z(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,i=document.createElement("canvas");i.width=e,i.height=1;for(var n=i.getContext("2d"),a=0;a<e;++a)n.fillStyle=t(a/(e-1)),n.fillRect(a,0,1,1);return i}function E(t,e){var i=e.toLowerCase().replace(/[^a-z0-9_]/g,"-"),a=n("container",this.containers.charts),s=n("header",a,"h3").text(e),r=n("legend",a);r.node().appendChild(function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.color,n=e.title,a=e.tickSize,s=void 0===a?6:a,r=e.width,o=void 0===r?320:r,l=e.height,c=void 0===l?44+s:l,d=e.marginTop,u=void 0===d?18:d,g=e.marginRight,h=void 0===g?0:g,p=e.marginBottom,f=void 0===p?16+s:p,v=e.marginLeft,m=void 0===v?0:v,y=e.ticks,x=void 0===y?o/64:y,S=e.tickFormat,_=e.tickValues,b=d3.create("svg").attr("width",o).attr("height",c).attr("viewBox",[0,0,o,c]).style("overflow","visible").style("display","block"),w=function(t){return t.selectAll(".tick line").attr("y1",u+f-c)};if(i.interpolate){var A=Math.min(i.domain().length,i.range().length);t=i.copy().rangeRound(d3.quantize(d3.interpolate(m,o-h),A)),b.append("image").attr("x",m).attr("y",u).attr("width",o-m-h).attr("height",c-u-f).attr("preserveAspectRatio","none").attr("xlink:href",z.call(this,i.copy().domain(d3.quantize(d3.interpolate(0,1),A))).toDataURL())}else if(i.interpolator){if(t=Object.assign(i.copy().interpolator(d3.interpolateRound(m,o-h)),{range:function(){return[m,o-h]}}),b.append("image").attr("x",m).attr("y",u).attr("width",o-m-h).attr("height",c-u-f).attr("preserveAspectRatio","none").attr("xlink:href",z.call(this,i.interpolator()).toDataURL()),!t.ticks){if(void 0===_){var k=Math.round(x+1);_=d3.range(k).map((function(t){return d3.quantile(i.domain(),t/(k-1))}))}"function"!=typeof S&&(S=d3.format(void 0===S?",f":S))}}else if(i.invertExtent){var I=i.thresholds?i.thresholds():i.quantiles?i.quantiles():i.domain(),j=void 0===S?function(t){return t}:"string"==typeof S?d3.format(S):S;t=d3.scaleLinear().domain([-1,i.range().length-1]).rangeRound([m,o-h]),b.append("g").selectAll("rect").data(i.range()).join("rect").attr("x",(function(e,i){return t(i-1)})).attr("y",u).attr("width",(function(e,i){return t(i)-t(i-1)})).attr("height",c-u-f).attr("fill",(function(t){return t})),_=d3.range(I.length),S=function(t){return j(I[t],t)}}else t=d3.scaleBand().domain(i.domain()).rangeRound([m,o-h]),b.append("g").selectAll("rect").data(i.domain()).join("rect").attr("x",t).attr("y",u).attr("width",Math.max(0,t.bandwidth()-1)).attr("height",c-u-f).attr("fill",i),w=function(){};return b.append("g").attr("transform","translate(0,".concat(c-f,")")).call(d3.axisBottom(t).ticks(x,"string"==typeof S?S:void 0).tickFormat("function"==typeof S?S:void 0).tickSize(s).tickValues(_)).call(w).call((function(t){return t.select(".domain").remove()})).call((function(t){t.append("text").attr("x",m).attr("y",u+f-c-6).attr("fill","currentColor").attr("text-anchor","start").attr("font-weight","bold").attr("font-size","1rem").text("-"),t.append("text").attr("x",o/2).attr("y",u+f-c-6).attr("fill","currentColor").attr("text-anchor","middle").attr("font-weight","bold").attr("font-size","1rem").html(n),t.append("text").attr("x",o-h).attr("y",u+f-c-6).attr("fill","currentColor").attr("text-anchor","end").attr("font-weight","bold").attr("font-size","1rem").text("+")})),b.node()}({color:t.colorScale,title:"change"===this.settings.color_var?"Change":'Percent Change <tspan dy = "-5" style = "font-size: 10px; font-weight: lighter">1 2</tspan>',width:275}));var o=n("time-series",a).classed("atm-svg-container",!0);o.svg=n("time-series__svg",o,"svg").attr("width",this.settings.width).attr("height",this.settings.height),o.xAxis=n("x-axis",o.svg,"g"),o.yAxis=n("y-axis",o.svg,"g"),o.canvas=n("canvas",o.svg,"g");return o.clipPath=n("clip-path",o.canvas,"clipPath").attr("id",i).append("rect").attr("x",this.settings.margin.left-6).attr("y",this.settings.margin.top).attr("width",this.settings.width-this.settings.margin.left-this.settings.margin.right+12).attr("height",this.settings.height-this.settings.margin.top-this.settings.margin.bottom),o.lines=n("lines",o.canvas,"g").attr("clip-path","url(#".concat(i,")")),o.points=n("points",o.canvas,"g").attr("clip-path","url(#".concat(i,")")),o.linesAggregate=n("lines-aggregate",o.canvas,"g").attr("clip-path","url(#".concat(i,")")),o.pointsAggregate=n("points-aggregate",o.canvas,"g").attr("clip-path","url(#".concat(i,")")),{main:a,header:s,legend:r,timeSeries:o}}function T(){var t=this;this.visitIndex=0,this.visit=this.data.visits[this.visitIndex],this.timepoint=this.data.timepoints[this.visitIndex],this.containers.timepoint.text(this.visit),this.xScale=C.call(this,this.data),this.data.groups.measure.forEach((function(e,i){e.xScale=t.xScale,e.yScale=L.call(t,e),e.colorScale=P.call(t,e),e.containers=E.call(t,e,i),e.ids=d3.group(e,(function(t){return t.id})),e.aggregate=t.data.visits.reduce((function(i,n){return i.push([n,d3[t.settings.aggregate](e.filter((function(t){return t.visit===n})),(function(t){return t.result})),d3[t.settings.aggregate](e.filter((function(t){return t.visit===n})),(function(t){return t.change})),d3[t.settings.aggregate](e.filter((function(t){return t.visit===n})),(function(t){return t.percent_change}))]),i}),[]),S.call(t,e)})),this.settings.paused||(this.interval=d3.interval((function(){c.call(t)}),this.settings.speed))}return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={data:e,element:n,settings:Object.assign(t,a),util:i};return s.containers=b.call(s),R.call(s),T.call(s),s}}));
