!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=i()}(this,(function(){"use strict";var t={id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",speed:2500,aggregate:"mean"};function i(t,i,e){return t.find((function(t){return t[i]===e}))}var e={getDatum:i,getValue:function(t,e,n,a){var r=i(t,e,n);return r?r[a]:null}};function n(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",n=i.append(e).classed("atm-".concat(t),!0);return n}function a(){var t=n("main",d3.select(this.element));return this.settings.width=t.node().clientWidth/2,this.settings.height=this.settings.width/3,this.settings.margin={top:25,right:10,bottom:40,left:60},{main:t,timepoint:n("timepoint",t,"h2")}}function r(t){return function(t){if(Array.isArray(t))return s(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,i){if(!t)return;if("string"==typeof t)return s(t,i);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(t);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return s(t,i)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,i){(null==i||i>t.length)&&(i=t.length);for(var e=0,n=new Array(i);e<i;e++)n[e]=t[e];return n}function o(){var t=this;this.data.every((function(t){return/^-?\d+\.?\d*$/.test(t.id)||/^-?\d*\.?\d+$/.test(t.id)}));this.data.forEach((function(i){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(e){i[e.replace(/_var$/,"")]=["visit_order_var","day_var","result_var"].includes(e)?+i[t.settings[e]]:i[t.settings[e]]}))}))}function c(){return{id:new Set(this.data.map((function(t){return t.id}))),visit:new Set(this.data.map((function(t){return t.visit}))),visit_order:new Set(this.data.map((function(t){return t.visit_order}))),day:new Set(this.data.map((function(t){return t.day}))),measure:new Set(this.data.map((function(t){return t.measure})))}}function l(){return{id:d3.group(this.data,(function(t){return t.id})),visit:d3.group(this.data,(function(t){return t.visit})),measure:d3.group(this.data,(function(t){return t.measure}))}}function u(){var t=this;o.call(this),this.data.sets=c.call(this),this.data.visits=r(new Set(this.data.map((function(t){return"".concat(t.visit_order,"|").concat(t.visit)}))).values()).map((function(t){return t.split("|")})).sort((function(t,i){return t[0]-i[0]})).map((function(t){return t[1]})),this.data.timepoints=this.data.visits.map((function(i){return d3.median(t.data.filter((function(t){return t.visit===i})),(function(t){return t.day}))})),this.data.groups=l.call(this)}function d(t){return d3.scaleLinear().domain(d3.extent(t,(function(t){return t.day}))).rangeRound([this.settings.margin.left,this.settings.width-this.settings.margin.right])}function g(t){return d3.scaleLinear().domain(d3.extent(t,(function(t){return t.result}))).nice().rangeRound([this.settings.height-this.settings.margin.bottom,this.settings.margin.top])}function h(t){var i=t.domain()[0],e=t.domain()[1];return d3.scaleSequential().domain([-Math.abs(e-i),Math.abs(e-i)]).interpolator(d3.interpolateViridis)}function f(t){t.toLowerCase().replace(/[^a-z0-9_]/g,"-");var i=n("container",this.containers.main).attr("width",this.settings.width).attr("height",this.settings.height),e=(n("header",i,"h3").text(t),n("svg",i,"svg").attr("width",this.settings.width).attr("height",this.settings.height)),a=n("x-axis",e,"g"),r=n("y-axis",e,"g"),s=n("canvas",e,"g"),o=n("lines",s,"g"),c=n("points",s,"g"),l=n("lines-aggregate",s,"g");return{main:i,svg:e,xAxis:a,yAxis:r,canvas:s,points:c,lines:o,pointsAggregate:n("points-aggregate",s,"g"),linesAggregate:l}}function p(t){var i=this;return t.containers.xAxis.attr("transform","translate(0,".concat(this.settings.height-this.settings.margin.bottom,")")).call(d3.axisBottom(t.xScale).ticks(this.settings.width/80)).call((function(t){return t.append("text").attr("x",(i.settings.width-i.settings.margin.left)/2).attr("y",i.settings.margin.bottom/2+4).attr("fill","currentColor").attr("text-anchor","center").attr("alignment-baseline","hanging").text("Study Day")}))}function v(t){var i=this;return t.containers.yAxis.attr("transform","translate(".concat(this.settings.margin.left,",0)")).call(d3.axisLeft(t.yScale)).call((function(t){return t.select(".domain").remove()})).call((function(e){return e.append("g").attr("stroke","currentColor").attr("stroke-opacity",.1).selectAll("line").data(t.yScale.ticks()).join("line").attr("y1",(function(i){return.5+t.yScale(i)})).attr("y2",(function(i){return.5+t.yScale(i)})).attr("x1",0).attr("x2",i.settings.width-i.settings.margin.right-i.settings.margin.left)}))}function m(t){return t.containers.lines.selectAll("line").data(t.ids,(function(t){return t[0]})).join("line").attr("stroke-opacity",0)}function y(t){var i=this;return t.containers.points.selectAll("circle").data(t.ids,(function(t){return t[0]})).join("circle").attr("cx",(function(e){return t.xScale(i.util.getValue(e[1],"visit",i.visit,"day"))})).attr("cy",(function(e){return t.yScale(i.util.getValue(e[1],"visit",i.visit,"result"))})).attr("r",1).attr("fill",t.colorScale(0)).attr("fill-opacity",.25).attr("stroke",t.colorScale(0)).attr("stroke-opacity",.5).style("display",(function(t){return i.util.getDatum(t[1],"visit",i.visit)?null:"none"}))}function x(t){var i=this;return t.containers.linesAggregate.selectAll("line.atm-line-aggregate").data(d3.pairs(t.aggregate)).join("line").classed("atm-line-aggregate",!0).attr("x1",(function(e,n){return t.xScale(i.data.timepoints[n])})).attr("x2",(function(e,n){return t.xScale(i.data.timepoints[n])})).attr("y1",(function(i){return t.yScale(i[0][1])})).attr("y2",(function(i){return t.yScale(i[0][1])})).attr("stroke",(function(i){return t.colorScale(i[1][1]-i[0][1])})).attr("stroke-width",3)}function S(t){return t.containers.pointsAggregate.append("circle").datum(t.aggregate).classed("atm-point-aggregate",!0).attr("cx",t.xScale(this.timepoint)).attr("cy",(function(i){return t.yScale(i[0][1])})).attr("r",4).attr("fill",t.colorScale(0)).attr("fill-opacity",1).attr("stroke","black").attr("stroke-opacity",1)}function A(t){t.xAxis=p.call(this,t),t.yAxis=v.call(this,t),t.lines=m.call(this,t),t.points=y.call(this,t),t.linesAggregate=x.call(this,t),t.pointsAggregate=S.call(this,t)}function b(t){var i=this;t.lines.each((function(e){var n=e[1].find((function(t){return t.visit===i.visit})),a=e[1].findIndex((function(t){return t.visit===i.visit})),r=e[1].slice(0,a).pop(),s=d3.select(this);r&&n?s.attr("x1",t.xScale(r.ADY)).attr("y1",t.yScale(r.AVAL)).attr("x2",t.xScale(r.ADY)).attr("y2",t.yScale(r.AVAL)).attr("stroke",t.colorScale(n.AVAL-r.AVAL)).attr("stroke-opacity",.25).transition().ease(d3.easeQuad).duration(2*i.settings.speed/5).attr("x2",t.xScale(n.ADY)).attr("y2",t.yScale(n.AVAL)):s.transition().duration(2*i.settings.speed/5).attr("stroke-opacity",0)}))}function w(t){var i=this;t.points.each((function(e){var n=e[1].find((function(t){return t.visit===i.visit})),a=e[1].find((function(t){return!!t.result})),r=d3.select(this);0!==i.visit||n?"none"===r.style("display")&&n&&r.attr("cx",t.xScale(n.day)).attr("cy",t.yScale(n.result)):r.style("display","none");var s=r.transition().ease(d3.easeQuad).duration(2*i.settings.speed/5).delay(1*i.settings.speed/5);n?s.attr("cx",t.xScale(n.day)).attr("cy",t.yScale(n.result)).attr("fill",a?t.colorScale(n.result-a.result):0).attr("fill-opacity",.25).attr("stroke",a?t.colorScale(n.result-a.result):0).style("display",null):s.attr("fill-opacity",.25).attr("stroke-opactiy",.5)}))}function I(t){var i=this;t.linesAggregate.filter((function(t,e){return e===i.visitIndex-1})).transition().duration(2*this.settings.speed/5).delay(1*this.settings.speed/5).attr("x2",(function(e,n){return t.xScale(i.timepoint)})).attr("y2",(function(i){return t.yScale(i[1][1])}))}function k(t){var i=this;t.pointsAggregate.transition().ease(d3.easeQuad).duration(2*this.settings.speed/5).delay(2*this.settings.speed/5).attr("cx",t.xScale(this.timepoint)).attr("cy",(function(e){return t.yScale(e[i.visitIndex][1])})).attr("fill",(function(e,n){return t.colorScale(e[i.visitIndex][1]-e[0][1])})).on("end",(function(){0===i.visitIndex&&t.containers.canvas.selectAll(".atm-clone").remove()})),t.pointsAggregate.clone().classed("atm-clone",!0)}function _(){var t=this;this.visitIndex=this.visitIndex>=this.data.visits.length-1?0:this.visitIndex+1,this.visit=this.data.visits[this.visitIndex],this.timepoint=this.data.timepoints[this.visitIndex],this.containers.timepoint.transition().delay(this.settings.speed/2).text(this.visit),this.data.groups.measure.forEach((function(i,e){b.call(t,i),w.call(t,i),I.call(t,i),k.call(t,i)}))}function V(){var t=this;this.visitIndex=0,this.visit=this.data.visits[this.visitIndex],this.timepoint=this.data.timepoints[this.visitIndex],console.log(this.timepoint),this.containers.timepoint.text(this.visit),this.xScale=d.call(this,this.data),this.data.groups.measure.forEach((function(i,e){i.xScale=t.xScale,i.yScale=g.call(t,i),i.colorScale=h.call(t,i.yScale),i.containers=f.call(t,e),i.ids=d3.group(i,(function(t){return t.id})),i.aggregate=t.data.visits.reduce((function(e,n){return e.push([n,d3[t.settings.aggregate](i.filter((function(t){return t.visit===n})),(function(t){return t.result}))]),e}),[]),A.call(t,i)})),d3.interval((function(){_.call(t)}),this.settings.speed)}return function(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={data:i,element:n,settings:Object.assign(t,r),util:e};return s.containers=a.call(s),u.call(s),V.call(s),s}}));
