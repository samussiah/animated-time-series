!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedTimeSeries=n()}(this,(function(){"use strict";d3.geomean=function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(t){return t},i=64,e=Math.pow(2,i),r=Math.pow(2,-i),a=1,s=0,o=1,u=0,l=0;l<t.length;l++){var c=n(t[l]);if(+c==+c){if(s++,0===(o=Math.sign(c)))return 0;for(a*=Math.abs(c);a>e;)a*=r,++u;for(;a<r;)a*=e,--u}}return s?o*Math.pow(2,(Math.log2(a)+u*i)/s):NaN},d3.mode=function(t){if(0==t.length)return null;for(var n={},i=t[0],e=1,r=0;r<t.length;r++){var a=t[r];null==n[a]?n[a]=1:n[a]++,n[a]>e&&(i=a,e=n[a])}return i};var t={addElement:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,n){return n};return e?n.selectAll("".concat(i,".atm-").concat(t,".atm-").concat(i)).data(e,r).join(i).classed("atm-".concat(t," atm-").concat(i),!0):n.append(i).classed("atm-".concat(t," atm-").concat(i),!0)}};function n(t){return null===t.color_var&&(t.color_var=t.stratification_var),null===t.var_labels.stratification&&(t.var_labels.stratification=t.stratification_var),["ordinal","discrete"].includes(t.xType)||(t.xType="ordinal"),"ordinal"===t.xType?t.xVar="visit":"discrete"===t.xType&&(t.xVar="timepoint"),t.footnotes=t.footnotes.map((function(n){return n.replace("[aggregate]",t.aggregate).replace("[outcome]",t.outcome)})),t}function i(){return{update:n,stratification_var:null,color_var:null,id_var:"USUBJID",visit_var:"AVISIT",visit_order_var:"AVISITN",day_var:"ADY",measure_var:"PARAM",result_var:"AVAL",var_labels:{stratification:null,color_var:null,id:"Participant ID",visit:"Visit",visit_order:"Visit Order",day:"Study Day",measure:"Measure",result:"Result"},aggregate:"mean",xType:"ordinal",xVar:"visit",play:!0,timepoint:0,speed:1e3,loopDelay:1e4,width:null,height:null,margin:{},annotate:!0,fontSize:15,fontWeight:"bold",footnotes:[]}}function e(t){var n=this.layout?this.layout.charts:t;this.settings.width=n.node().clientWidth/1,this.settings.height=this.settings.width/3,this.settings.margin={top:30,right:30,bottom:40,left:40}}function r(t){return this.util.addElement("charts",t)}function a(){e.call(this)}function s(){var t=this.util.addElement("main",d3.select(this.element)),n=r.call(this,t);return e.call(this,n),window.addEventListener("resize",a.bind(this)),{main:t,charts:n}}function o(){var t=this;this.data.forEach((function(n){Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})).forEach((function(i){n[i.replace(/_var$/,"")]=["visit_order_var","day_var","result_var","baseline_var","change_var","percent_change_var"].includes(i)?parseFloat(n[t.settings[i]]):n[t.settings[i]]}))}))}function u(t){return function(t){if(Array.isArray(t))return c(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||l(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,n){if(t){if("string"==typeof t)return c(t,n);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?c(t,n):void 0}}function c(t,n){(null==n||n>t.length)&&(n=t.length);for(var i=0,e=new Array(n);i<n;i++)e[i]=t[i];return e}function f(t,n){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=l(t))||n&&t&&"number"==typeof t.length){i&&(t=i);var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return s=t.done,t},e:function(t){o=!0,a=t},f:function(){try{s||null==i.return||i.return()}finally{if(o)throw a}}}}function d(t,n){var i;switch(t){case"visit":i=u(new Set(n.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,n){return t.replace(/.*\|/,"")-n.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:i=u(new Set(n.map((function(n){return n[t]}))).values()).sort()}return i}function h(t,n){var i;switch(t){case"stratification,visit":i=d3.groups(n,(function(t){return t.stratification}),(function(t){return t.visit}));break;case"measure,id":i=d3.groups(n,(function(t){return t.measure}),(function(t){return t.id}));break;default:i=d3.group(n,(function(n){return n[t]}))}return i}function v(t,n){return{index:t,visit:n.visit[t],visit_order:n.visit_order[t]}}function m(){o.call(this),this.set=function(t){var n={};return n.stratification=d("stratification",t),n.color=d("color",t),n.id=d("id",t),n.visit=d("visit",t),n.visit_order=d("visit_order",t),n.day=d("day",t),n.measure=d("measure",t),n.timepoint=n.visit.map((function(n){return d3.median(t.filter((function(t){return t.visit===n})),(function(t){return t.day}))})),n}(this.data),this.group=function(t){var n={};return n.stratification=h("stratification",t),n.stratification_visit=h("stratification,visit",t),n.color=h("color",t),n.id=h("id",t),n.visit=h("visit",t),n.measure=h("measure",t),n.measure_id=h("measure,id",t),n}(this.data),this.summary=function(t,n,i){var e=d3.rollups(t,(function(t){return{data:t,value:d3[i.aggregate](t,(function(t){return t.result}))}}),(function(t){return t.measure}),(function(t){return t.stratification}),(function(t){return t.visit}));return e.forEach((function(t,e){var r=Array(n.stratification.length*n.visit.length);n.stratification.forEach((function(e,a){var s=t[1].find((function(t){return t[0]===e}));void 0===s&&(s=[e,n.visit.map((function(t){return[t,{data:[],value:null}]}))],t[1].splice(a,0,s)),s&&s[1].sort((function(t,i){return n.visit.indexOf(t[0])-n.visit.indexOf(i[0])})),s.color_value=s[1][0][1].data[0][i.color_var],n.visit.forEach((function(i,e){var o=s[1].find((function(t){return t[0]===i}));void 0===o&&(o=u(s[1][e-1]),s[1].splice(e,0,o)),o.visit=o[0],o.index=n.visit.findIndex((function(t){return t===o[0]})),o.visit_order=n.visit_order[o.index],o.timepoint=n.timepoint[o.index],o.stratum=s;var l={measure:t[0],stratum:s[0],visit:o[0],value:o[0]===i?o[1].value:null};r[a*n.visit.length+e]=l}))})),t.tabular=r.filter((function(t){return!0})),t.visits=u(new Set(t.tabular.map((function(t){return t.visit}))).values())})),e}(this.data,this.set,this.settings),this.timepoint=v(this.settings.timepoint,this.set)}function g(t,n){var i=this.util.addElement("container",this.layout.charts),e=this.util.addElement("header",i,"h3").text(t),r=n.width+n.margin.left+n.margin.right,a=n.height+n.margin.top+n.margin.bottom,s=n.margin,o=this.util.addElement("time-series__svg",i,"svg").attr("width",r).attr("height",a).append("g").attr("transform","translate("+s.left+","+s.top+")");return o.dimensions=n,o.width=r,o.height=a,o.margin=s,{main:i,header:e,svg:o}}function p(t,n){return d3.scaleLinear().domain([d3.min(t),d3.max(t)]).nice().range([n.height,0])}function y(t,n,i,e){var r=n.append("g").classed("atm-axis",!0).attr("transform","translate(0,"+n.dimensions.height+")");return"ordinal"===t?r.call(d3.axisBottom(e)):r.call(d3.axisBottom(e).tickValues(i.timepoint).tickFormat((function(t,n){return i.visit[n]}))),r.selectAll("text").style("text-anchor","end").attr("transform","rotate(-45)").attr("dx","-.8em").attr("dy",".15em"),r}function x(t,n){var i=t.append("g").classed("atm-axis",!0).call(d3.axisLeft(n));return i.grid=t.append("g").call((function(i){return i.attr("class","grid-lines").selectAll("line").data(n.ticks()).join("line").attr("x1",0).attr("x2",t.dimensions.width).attr("y1",(function(t){return n(t)})).attr("y2",(function(t){return n(t)}))})),i}function _(t,n,i){var e=this,r=d3.line().x((function(t){return i.x(t[e.settings.xVar])})).y((function(t){return i.y(t[1].value)})),a=t.selectAll("path.line").data(n).join("path").classed("line",!0);return a.attr("d",(function(t){var n=t[1][e.settings.timepoint],i=t[1].map((function(t,i){return i>=e.settings.timepoint?n:t}));return r(i)})).attr("stroke",(function(t){return i.color(t.color_value)})).attr("stroke-width",Math.max(12/this.set.stratification.length,1)).attr("fill","none"),a.lineGenerator=r,a}function b(t,n,i){var e=this,r=t.selectAll("g.point-group").data(n,(function(t){return t[0]})).join("g").classed("point-group",!0);return r.attr("fill",(function(t){return i.color(t.color_value)})),r.selectAll("circle.point").data((function(t){return t[1].slice(0,e.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join("circle").classed("point",!0).attr("cx",(function(t){return i.x(t[e.settings.xVar])})).attr("cy",(function(t){return i.y(t[1].value)})).attr("r",5).attr("stroke","white"),r}function w(t){var n=this.settings.fontSize;t.sort((function(t,n){return n.y-t.y})).forEach((function(i,e){if(e>0){var r=t[e-1].y-i.y;r<n&&(i.y=i.y-(n-r))}}))}function A(t,n,i){var e=this,r=t.selectAll("text.annotation").data(n).join("text").classed("annotation",!0);return r.datum((function(t){var n=t[1][e.settings.timepoint];return{x:i.x(n[e.settings.xVar]),y:i.y(n[1].value),color:i.color(t[0]),text:t[0],stratum:t}})),w.call(this,r.data()),r.attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y})).attr("dx",7).attr("dy",this.settings.fontSize/3).attr("fill",(function(t){return t.color})).style("font-size",this.settings.fontSize).style("font-weight",this.settings.fontWeight).text((function(t){return t.text})),r}function S(t,n){var i=this;t.transition().duration(this.settings.speed).attr("d",(function(n){var e=n[1][i.settings.timepoint],r=n[1].map((function(t,n){return n>=i.settings.timepoint?e:t}));return t.lineGenerator(r)}))}function j(t,n){var i=this;return t.selectAll("circle.point").data((function(t){return t[1].slice(0,i.settings.timepoint+1)}),(function(t,n){return[t.stratum[0],n].join("|")})).join((function(t){return t.append("circle").classed("point",!0).attr("r",5).attr("stroke","white").attr("cx",(function(t){var e=t.stratum[1][i.settings.timepoint-1];return n.x(e[i.settings.xVar])})).attr("cy",(function(t){var e=t.stratum[1][i.settings.timepoint-1];return n.y(e[1].value)})).call((function(t){return t.transition().duration(i.settings.speed).attr("cx",(function(t){return n.x(t[i.settings.xVar])})).attr("cy",(function(t){return n.y(t[1].value)}))}))})),t}function V(t,n){var i=this;t.datum((function(t){var e=t.stratum[1][i.settings.timepoint];return{x:n.x(e[i.settings.xVar]),y:n.y(e[1].value),color:n.color(t[0]),text:t[0],stratum:t.stratum}})),w.call(this,t.data()),t.transition().duration(this.settings.speed).attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y}))}function E(){var t,n=this,i=function(t){var n={top:2*t.fontSize,right:100,bottom:55,left:50};return{margin:n,width:500-n.left-n.right,height:200-n.top-n.bottom}}(this.settings),e=function(t,n,i){var e;if("ordinal"===t)e=d3.scalePoint().domain(n).range([0,i.width]).padding([.5]);else{var r=d3.extent(n),a=r[1]-r[0];e=d3.scaleLinear().domain([r[0]-.05*a,r[1]+.05*a]).range([0,i.width])}return e}(this.settings.xType,this.set[this.settings.xVar],i),r=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d3.schemeSet2,i=d3.scaleOrdinal().domain(t).range(n);return i}(this.set.color),a=f(this.summary);try{for(a.s();!(t=a.n()).done;){var s=t.value,o=s[1],u=g.call(this,s[0],i);s.scales={x:e.copy(),y:p(s.tabular.map((function(t){return t.value})),i),color:r.copy()},s.xAxis=y(this.settings.xType,u.svg,this.set,s.scales.x,s.visits),s.yAxis=x(u.svg,s.scales.y),s.lines=_.call(this,u.svg,o,s.scales),s.points=b.call(this,u.svg,o,s.scales),this.settings.annotate&&(s.annotations=A.call(this,u.svg,o,s.scales))}}catch(t){a.e(t)}finally{a.f()}var l=function(){if(this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length)this.interval.stop(),this.settings.timepoint=0;else{this.timepoint=v(this.settings.timepoint,this.set);var t,n=f(this.summary);try{for(n.s();!(t=n.n()).done;){var i=t.value;S.call(this,i.lines,i.scales),j.call(this,i.points,i.scales),this.settings.annotate&&V.call(this,i.annotations,i.scales)}}catch(t){n.e(t)}finally{n.f()}}};this.interval=d3.interval((function(){l.call(n)}),this.settings.speed)}return function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a={data:n,element:e,settings:i().update(Object.assign(i(),r)),util:t};return a.layout=s.call(a),m.call(a),E.call(a),a}}));
